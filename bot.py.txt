import asyncio
import logging
import json
import os
import sys
import random
from datetime import datetime
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.memory import MemoryStorage

# ==================== –ù–ê–°–¢–†–û–ô–ö–ê ====================
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
BOT_TOKEN = "8156674134:AAH2t8wCtxo95-_t3HQUFaOMBBHVPMWdQaU"  # –í–∞—à —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
ADMIN_ID = 951154134  # ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–¥—Ä—É–≥–∞)
AUTHOR_ID = 951154134  # ID –∞–≤—Ç–æ—Ä–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ—Ç –∂–µ, —á—Ç–æ –∏ –∞–¥–º–∏–Ω)

# –ö–æ–Ω—Ç–∞–∫—Ç—ã
SUPPORT_USERNAME = "@svetonaya"
AUTHOR_USERNAME = "@svetonaya"  # –ê–≤—Ç–æ—Ä –¥–ª—è –≤—ã–¥–∞—á–∏ –Ω–æ–º–µ—Ä–æ–≤
CHANNEL_LINK = "https://t.me/shopsfiznumber"
CREATOR_LINK = "@UGLYLELOOSH"

# –†–µ–∫–≤–∏–∑–∏—Ç—ã –∫–∞—Ä—Ç—ã (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò!)
CARD_NUMBER = "2200 1234 5678 9012"  # –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã
CARD_HOLDER = "–ò–í–ê–ù –ò–í–ê–ù–û–í"           # –ò–º—è –¥–µ—Ä–∂–∞—Ç–µ–ª—è

# –§–∞–π–ª—ã –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
DATA_FILE = "numbers.json"
REVIEWS_FILE = "reviews.json"
PENDING_ORDERS_FILE = "pending_orders.json"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
if not BOT_TOKEN:
    logger.error("‚ùå –û–®–ò–ë–ö–ê: BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    sys.exit(1)

# ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
bot = Bot(token=BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–ö–†–´–¢–ò–Ø –ù–û–ú–ï–†–û–í ====================
def mask_phone_number(phone_number: str) -> str:
    """–°–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞—è —Ç–æ–ª—å–∫–æ –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã"""
    if not phone_number:
        return "********"
    
    # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã, –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–∫—Ä—ã–≤–∞–µ–º
    parts = phone_number.split(' ')
    if len(parts) > 1:
        # –ï—Å–ª–∏ –Ω–æ–º–µ—Ä —Å –ø—Ä–æ–±–µ–ª–∞–º–∏: +7 123 456 7890 ‚Üí +7 *** *** ****
        country_code = parts[0]
        masked_parts = ['***' for _ in range(len(parts) - 1)]
        return f"{country_code} {' '.join(masked_parts)}"
    else:
        # –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤: +71234567890 ‚Üí +7*********
        if len(phone_number) > 4:
            return phone_number[:3] + "*" * (len(phone_number) - 3)
        return "********"

def generate_random_mask() -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é –º–∞—Å–∫—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    masks = [
        "*** *** ****",
        "*** **** ***",
        "**** *** ***",
        "***-***-****",
        "****-***-***"
    ]
    return random.choice(masks)

def format_phone_display(country: str, phone_number: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –Ω–æ–º–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –±–æ—Ç–µ"""
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã –∏–∑ –Ω–æ–º–µ—Ä–∞
    if phone_number.startswith('+'):
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É
        if phone_number.startswith('+880'):  # –ë–∞–Ω–≥–ª–∞–¥–µ—à
            return f"+880 {generate_random_mask()}"
        elif phone_number.startswith('+84'):  # –í—å–µ—Ç–Ω–∞–º
            return f"+84 {generate_random_mask()}"
        elif phone_number.startswith('+91'):  # –ò–Ω–¥–∏—è
            return f"+91 {generate_random_mask()}"
        elif phone_number.startswith('+95'):  # –ú—å—è–Ω–º–∞
            return f"+95 {generate_random_mask()}"
        elif phone_number.startswith('+7'):   # –†–æ—Å—Å–∏—è/–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω
            return f"+7 {generate_random_mask()}"
        elif phone_number.startswith('+1'):   # –°–®–ê/–ö–∞–Ω–∞–¥–∞
            return f"+1 {generate_random_mask()}"
        else:
            # –û–±—â–∏–π —Å–ª—É—á–∞–π: –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã, –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–∫—Ä—ã–≤–∞–µ–º
            code = phone_number[:4] if len(phone_number) >= 4 else phone_number
            return f"{code} {generate_random_mask()}"
    else:
        return f"{country}: ********"

# ==================== –°–û–°–¢–û–Ø–ù–ò–Ø FSM ====================
class AdminStates(StatesGroup):
    adding_country = State()
    adding_number = State()
    adding_multiple_numbers = State()
    editing_price = State()
    waiting_review = State()

# ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –î–ê–ù–ù–´–ú–ò ====================
def load_numbers():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–æ–º–µ—Ä–∞ –∏–∑ —Ñ–∞–π–ª–∞"""
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {}
    return {}

def save_numbers(data):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–º–µ—Ä–∞ –≤ —Ñ–∞–π–ª"""
    with open(DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

def load_reviews():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –æ—Ç–∑—ã–≤—ã –∏–∑ —Ñ–∞–π–ª–∞"""
    if os.path.exists(REVIEWS_FILE):
        try:
            with open(REVIEWS_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {"reviews": []}
    return {"reviews": []}

def save_reviews(data):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–∑—ã–≤—ã –≤ —Ñ–∞–π–ª"""
    with open(REVIEWS_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

def load_pending_orders():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –æ–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã"""
    if os.path.exists(PENDING_ORDERS_FILE):
        try:
            with open(PENDING_ORDERS_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {}
    return {}

def save_pending_orders(data):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã"""
    with open(PENDING_ORDERS_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

def init_data():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (–ü–£–°–¢–£–Æ!)"""
    data = load_numbers()
    if not data:
        initial_data = {
            "–ë–∞–Ω–≥–ª–∞–¥–µ—à": {
                "price": 120,
                "numbers": []
            },
            "–í—å–µ—Ç–Ω–∞–º": {
                "price": 115,
                "numbers": []
            },
            "–ò–Ω–¥–∏—è": {
                "price": 100,
                "numbers": []
            },
            "–ú—å—è–Ω–º–∞": {
                "price": 130,
                "numbers": []
            }
        }
        save_numbers(initial_data)
        logger.info("‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–ø—É—Å—Ç–∞—è)")
    
    if not os.path.exists(REVIEWS_FILE):
        save_reviews({"reviews": []})
    
    if not os.path.exists(PENDING_ORDERS_FILE):
        save_pending_orders({})
    
    return data

# ==================== –§–£–ù–ö–¶–ò–Ø 1: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–¥–∞—á–∏ —Ç–æ–≤–∞—Ä–∞ ====================
@dp.callback_query(lambda c: c.data.startswith("confirm_delivery_"))
async def confirm_delivery(callback: types.CallbackQuery):
    """–ê–≤—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –≤—ã–¥–∞—á—É —Ç–æ–≤–∞—Ä–∞"""
    if callback.from_user.id != AUTHOR_ID:
        await callback.answer("‚ùå –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å –≤—ã–¥–∞—á—É")
        return
    
    order_id = callback.data.split("_")[2]
    pending_orders = load_pending_orders()
    
    if order_id not in pending_orders:
        await callback.answer("‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    order_info = pending_orders[order_id]
    country = order_info["country"]
    number_id = order_info["number_id"]
    actual_number = order_info["actual_number"]  # –†–µ–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä
    
    # –£–¥–∞–ª—è–µ–º –Ω–æ–º–µ—Ä –∏–∑ –±–∞–∑—ã
    data = load_numbers()
    
    number_found = False
    for i, num in enumerate(data[country]["numbers"]):
        if num["id"] == number_id:
            del data[country]["numbers"][i]
            number_found = True
            break
    
    if not number_found:
        await callback.answer("‚ùå –ù–æ–º–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ")
        return
    
    save_numbers(data)
    
    # –£–¥–∞–ª—è–µ–º –∑–∞–∫–∞–∑ –∏–∑ –æ–∂–∏–¥–∞—é—â–∏—Ö
    del pending_orders[order_id]
    save_pending_orders(pending_orders)
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–∫—É–ø–∞—Ç–µ–ª—è —Å –†–ï–ê–õ–¨–ù–´–ú –Ω–æ–º–µ—Ä–æ–º
    try:
        buyer_id = order_info["user_id"]
        await bot.send_message(
            buyer_id,
            f"‚úÖ –ê–≤—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤—ã–¥–∞—á—É –Ω–æ–º–µ—Ä–∞!\n\n"
            f"üåç –°—Ç—Ä–∞–Ω–∞: {country}\n"
            f"üìû –ù–æ–º–µ—Ä: <code>{actual_number}</code>\n"
            f"üí∞ –¶–µ–Ω–∞: {order_info['price']}‚ÇΩ\n\n"
            f"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É! üõçÔ∏è\n\n"
            f"‚≠ê –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤!",
            parse_mode="HTML"
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è: {e}")
    
    await callback.message.edit_text(
        f"‚úÖ –í—ã–¥–∞—á–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!\n\n"
        f"üìû –†–µ–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–∫—É–ø–∞—Ç–µ–ª—é.\n"
        f"üåç –°—Ç—Ä–∞–Ω–∞: {country}\n"
        f"üí∞ –¶–µ–Ω–∞: {order_info['price']}‚ÇΩ\n"
        f"üë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω."
    )
    
    logger.info(f"–ê–≤—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤—ã–¥–∞—á—É –∑–∞–∫–∞–∑–∞ {order_id}")

@dp.callback_query(lambda c: c.data.startswith("cancel_delivery_"))
async def cancel_delivery(callback: types.CallbackQuery):
    """–ê–≤—Ç–æ—Ä –æ—Ç–º–µ–Ω—è–µ—Ç –≤—ã–¥–∞—á—É (–æ—Ç–∫–∞–∑ –∑–∞–∫–∞–∑–∞)"""
    if callback.from_user.id != AUTHOR_ID:
        await callback.answer("‚ùå –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω—è—Ç—å –∑–∞–∫–∞–∑—ã")
        return
    
    order_id = callback.data.split("_")[2]
    pending_orders = load_pending_orders()
    
    if order_id in pending_orders:
        del pending_orders[order_id]
        save_pending_orders(pending_orders)
    
    await callback.message.edit_text(
        "‚ùå –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω.\n"
        "–ù–æ–º–µ—Ä –æ—Å—Ç–∞–ª—Å—è –≤ –ø—Ä–æ–¥–∞–∂–µ."
    )
    
    await admin_panel(callback)

# ==================== –§–£–ù–ö–¶–ò–Ø 2: –°–∏—Å—Ç–µ–º–∞ –æ—Ç–∑—ã–≤–æ–≤ ====================
@dp.callback_query(lambda c: c.data == "reviews")
async def show_reviews(callback: types.CallbackQuery):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–∑—ã–≤—ã"""
    reviews_data = load_reviews()
    reviews = reviews_data.get("reviews", [])
    
    if not reviews:
        await callback.message.answer("üì≠ –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!")
        return
    
    recent_reviews = reviews[-5:]
    
    text = "‚≠ê –û—Ç–∑—ã–≤—ã –Ω–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤:\n\n"
    
    for i, review in enumerate(recent_reviews, 1):
        user_info = review.get("username", f"ID: {review.get('user_id', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}")
        rating = "‚≠ê" * min(5, int(review.get("rating", 5)))
        date = datetime.fromisoformat(review.get("date", datetime.now().isoformat())).strftime("%d.%m.%Y")
        
        text += f"{i}. {user_info}\n"
        text += f"   {rating}\n"
        if review.get("comment"):
            text += f"   üí¨ {review.get('comment')[:50]}"
            if len(review.get("comment", "")) > 50:
                text += "..."
        text += f"\n   üìÖ {date}\n\n"
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="üí¨ –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤", callback_data="leave_review"))
    keyboard.add(InlineKeyboardButton(text="üì¢ –í—Å–µ –æ—Ç–∑—ã–≤—ã –≤ –∫–∞–Ω–∞–ª–µ", url=CHANNEL_LINK))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(text, reply_markup=keyboard.as_markup())

@dp.callback_query(lambda c: c.data == "leave_review")
async def leave_review_start(callback: types.CallbackQuery, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞"""
    await state.set_state(AdminStates.waiting_review)
    
    keyboard = InlineKeyboardBuilder()
    for i in range(1, 6):
        keyboard.add(InlineKeyboardButton(text="‚≠ê" * i, callback_data=f"rating_{i}"))
    keyboard.add(InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="reviews"))
    keyboard.adjust(3, 2)
    
    await callback.message.edit_text(
        "üí¨ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ü–µ–Ω–∏—Ç–µ –Ω–∞—à —Å–µ—Ä–≤–∏—Å:\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥ –æ—Ç 1 –¥–æ 5:",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data.startswith("rating_"))
async def set_rating(callback: types.CallbackQuery, state: FSMContext):
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞"""
    rating = int(callback.data.split("_")[1])
    await state.update_data(rating=rating)
    
    await callback.message.edit_text(
        f"‚≠ê –í—ã –æ—Ü–µ–Ω–∏–ª–∏ –Ω–∞ {rating}/5\n\n"
        f"–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'):\n\n"
        f"üìù –ù–∞–ø–∏—à–∏—Ç–µ '–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å' —á—Ç–æ–±—ã –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
    )

@dp.message(AdminStates.waiting_review)
async def process_review_comment(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∫ –æ—Ç–∑—ã–≤—É"""
    user_data = await state.get_data()
    rating = user_data.get("rating", 5)
    comment = message.text if message.text.lower() != "–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å" else ""
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∑—ã–≤
    reviews_data = load_reviews()
    review = {
        "user_id": message.from_user.id,
        "username": f"@{message.from_user.username}" if message.from_user.username else f"ID: {message.from_user.id}",
        "rating": rating,
        "comment": comment,
        "date": datetime.now().isoformat()
    }
    reviews_data["reviews"].append(review)
    save_reviews(reviews_data)
    
    if comment:
        response = f"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤!\n–†–µ–π—Ç–∏–Ω–≥: {'‚≠ê' * rating}\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω."
    else:
        response = f"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ü–µ–Ω–∫—É!\n–†–µ–π—Ç–∏–Ω–≥: {'‚≠ê' * rating}"
    
    await message.answer(response)
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞ –æ –Ω–æ–≤–æ–º –æ—Ç–∑—ã–≤–µ
    try:
        await bot.send_message(
            ADMIN_ID,
            f"üì£ –ù–û–í–´–ô –û–¢–ó–´–í!\n\n"
            f"üë§ –û—Ç: {review['username']}\n"
            f"‚≠ê –†–µ–π—Ç–∏–Ω–≥: {'‚≠ê' * rating}\n"
            f"üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {comment[:100]}{'...' if len(comment) > 100 else '' if comment else '–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}"
        )
    except:
        pass
    
    await state.clear()

# ==================== –§–£–ù–ö–¶–ò–Ø 3: –£–ª—É—á—à–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É ====================
async def notify_admin_about_selection(user_id: int, username: str, country: str, number_id: int, display_number: str, actual_number: str, price: int):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–¥–º–∏–Ω—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã–±–æ—Ä–µ –Ω–æ–º–µ—Ä–∞"""
    try:
        user_info = f"@{username}" if username else f"ID: {user_id}"
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ
        order_id = f"{user_id}_{int(datetime.now().timestamp())}"
        pending_orders = load_pending_orders()
        
        pending_orders[order_id] = {
            "user_id": user_id,
            "username": username,
            "country": country,
            "number_id": number_id,
            "display_number": display_number,  # –°–∫—Ä—ã—Ç—ã–π –Ω–æ–º–µ—Ä –¥–ª—è –ø–æ–∫–∞–∑–∞
            "actual_number": actual_number,    # –†–µ–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –¥–ª—è –≤—ã–¥–∞—á–∏
            "price": price,
            "selected_at": datetime.now().isoformat()
        }
        save_pending_orders(pending_orders)
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
        keyboard = InlineKeyboardBuilder()
        keyboard.add(InlineKeyboardButton(
            text="‚úÖ –ù–æ–º–µ—Ä –±—ã–ª –≤—ã–¥–∞–Ω",
            callback_data=f"confirm_delivery_{order_id}"
        ))
        keyboard.add(InlineKeyboardButton(
            text="‚ùå –û—Ç–∫–∞–∑ –∑–∞–∫–∞–∑–∞",
            callback_data=f"cancel_delivery_{order_id}"
        ))
        keyboard.adjust(1)
        
        message_text = (
            f"_–Æ–ó_ –æ—Å–º–æ—Ç—Ä–µ–ª —ç—Ç–æ—Ç –Ω–æ–º–µ—Ä –∏ –¥—É–º–∞–µ—Ç –∫—É–ø–∏—Ç—å –µ–≥–æ\n"
            f"–∂–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–∏—á–∫–µ!\n\n"
            f"üë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å: {user_info}\n"
            f"üåç –°—Ç—Ä–∞–Ω–∞: {country}\n"
            f"üìû –ù–æ–º–µ—Ä (–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ): {display_number}\n"
            f"üìû –ù–æ–º–µ—Ä (—Ä–µ–∞–ª—å–Ω—ã–π): {actual_number}\n"
            f"üí∞ –¶–µ–Ω–∞: {price}‚ÇΩ\n"
            f"üÜî ID –Ω–æ–º–µ—Ä–∞: {number_id}\n"
            f"üïí –í—Ä–µ–º—è: {datetime.now().strftime('%H:%M:%S')}"
        )
        
        await bot.send_message(
            ADMIN_ID,
            message_text,
            parse_mode="Markdown",
            reply_markup=keyboard.as_markup()
        )
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞: {e}")

# ==================== –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´ –ë–û–¢–ê ====================
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    keyboard = InlineKeyboardBuilder()
    
    keyboard.add(InlineKeyboardButton(text="üì± –ö—É–ø–∏—Ç—å –Ω–æ–º–µ—Ä", callback_data="buy_number"))
    keyboard.add(InlineKeyboardButton(text="‚≠ê –û—Ç–∑—ã–≤—ã", callback_data="reviews"))
    keyboard.add(InlineKeyboardButton(text="‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data="info"))
    keyboard.add(InlineKeyboardButton(text="ü§ù –ê–ª—å—è–Ω—Å", callback_data="alliance"))
    keyboard.add(InlineKeyboardButton(text="üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞", url=f"https://t.me/{SUPPORT_USERNAME[1:]}"))
    
    if message.from_user.id == ADMIN_ID:
        keyboard.add(InlineKeyboardButton(text="‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_panel"))
    
    keyboard.adjust(1)
    
    await message.answer(
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–µ —Ñ–∏–∑ –Ω–æ–º–µ—Ä–æ–≤!\n\n"
        "üì± –ù–æ–º–µ—Ä–∞ —Å–∫—Ä—ã—Ç—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.\n"
        "üîí –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä.\n\n"
        "üõí –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data == "buy_number")
async def show_countries(callback: types.CallbackQuery):
    data = load_numbers()
    
    if not data:
        await callback.message.answer("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤.")
        return
    
    keyboard = InlineKeyboardBuilder()
    
    for country, info in data.items():
        available_count = sum(1 for num in info["numbers"] if not num.get("used", False))
        if available_count > 0:
            keyboard.add(InlineKeyboardButton(
                text=f"üìç {country} ({available_count} —à—Ç.) - {info['price']}‚ÇΩ",
                callback_data=f"country_{country}"
            ))
    
    keyboard.add(InlineKeyboardButton(text="‚≠ê –û—Ç–∑—ã–≤—ã", callback_data="reviews"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        "üåç –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –Ω–æ–º–µ—Ä–∞:\n"
        "üì± –ù–æ–º–µ—Ä–∞ —Å–∫—Ä—ã—Ç—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\n"
        "(–≤ —Å–∫–æ–±–∫–∞—Ö —É–∫–∞–∑–∞–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤)",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data.startswith("country_"))
async def show_numbers_by_country(callback: types.CallbackQuery):
    country = callback.data.split("_")[1]
    data = load_numbers()
    
    if country not in data:
        await callback.answer("‚ùå –°—Ç—Ä–∞–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    country_info = data[country]
    available_numbers = [num for num in country_info["numbers"] if not num.get("used", False)]
    
    if not available_numbers:
        await callback.answer("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤")
        return
    
    keyboard = InlineKeyboardBuilder()
    
    for number in available_numbers:
        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–∫—Ä—ã—Ç—ã–π –Ω–æ–º–µ—Ä
        display_number = format_phone_display(country, number["number"])
        button_text = f"üìû {display_number} - {number['price']}‚ÇΩ"
        
        # –î–ª—è –∞–¥–º–∏–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –≤ callback_data
        if callback.from_user.id == ADMIN_ID:
            button_text = f"üìû {number['number']} - {number['price']}‚ÇΩ"
        
        keyboard.add(InlineKeyboardButton(
            text=button_text,
            callback_data=f"select_number_{country}_{number['id']}"
        ))
    
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç—Ä–∞–Ω–∞–º", callback_data="buy_number"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        f"üì± –î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ ({country}):\n\n"
        f"üí≥ –¶–µ–Ω–∞: {country_info['price']}‚ÇΩ –∑–∞ –Ω–æ–º–µ—Ä\n"
        f"üìä –î–æ—Å—Ç—É–ø–Ω–æ: {len(available_numbers)} —à—Ç.\n"
        f"üîí –ù–æ–º–µ—Ä–∞ —Å–∫—Ä—ã—Ç—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–ª—è –ø–æ–∫—É–ø–∫–∏:",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data.startswith("select_number_"))
async def select_number(callback: types.CallbackQuery):
    parts = callback.data.split("_")
    country = parts[2]
    number_id = int(parts[3])
    
    data = load_numbers()
    
    # –ù–∞–π—Ç–∏ –Ω–æ–º–µ—Ä
    number_info = None
    for num in data[country]["numbers"]:
        if num["id"] == number_id and not num.get("used", False):
            number_info = num
            break
    
    if not number_info:
        await callback.answer("‚ùå –ù–æ–º–µ—Ä —É–∂–µ –ø—Ä–æ–¥–∞–Ω")
        return
    
    # –°–∫—Ä—ã—Ç—ã–π –Ω–æ–º–µ—Ä –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é
    display_number = format_phone_display(country, number_info["number"])
    
    payment_text = (
        f"‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏:\n\n"
        f"üåç –°—Ç—Ä–∞–Ω–∞: {country}\n"
        f"üìû –ù–æ–º–µ—Ä: {display_number}\n"
        f"üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: {number_info['price']}‚ÇΩ\n\n"
        f"üí≥ –û–ø–ª–∞—Ç–∞ –ø–æ –∫–∞—Ä—Ç–µ:\n\n"
        f"1. –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ {number_info['price']}‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É:\n"
        f"   üí≥ {CARD_NUMBER}\n"
        f"   üë§ {CARD_HOLDER}\n\n"
        f"2. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞:\n"
        f"   üì® {AUTHOR_USERNAME}\n\n"
        f"3. –ê–≤—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø–ª–∞—Ç–µ–∂ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –ü–û–õ–ù–´–ô –Ω–æ–º–µ—Ä\n\n"
        f"‚ö†Ô∏è –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:\n"
        f"   –ü–æ–∫—É–ø–∫–∞ {country} ‚Ññ{number_id}\n\n"
        f"üîí –ù–æ–º–µ—Ä —Å–∫—Ä—ã—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã."
    )
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(
        text="üì® –ù–∞–ø–∏—Å–∞—Ç—å –∞–≤—Ç–æ—Ä—É —Å —á–µ–∫–æ–º", 
        url=f"https://t.me/{AUTHOR_USERNAME[1:]}"
    ))
    keyboard.add(InlineKeyboardButton(
        text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –Ω–æ–º–µ—Ä–∞–º", 
        callback_data=f"country_{country}"
    ))
    keyboard.adjust(1)
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞ –æ –≤—ã–±–æ—Ä–µ –Ω–æ–º–µ—Ä–∞
    await notify_admin_about_selection(
        user_id=callback.from_user.id,
        username=callback.from_user.username,
        country=country,
        number_id=number_id,
        display_number=display_number,
        actual_number=number_info['number'],  # –†–µ–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä
        price=number_info['price']
    )
    
    await callback.message.edit_text(
        payment_text,
        reply_markup=keyboard.as_markup()
    )

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
@dp.callback_query(lambda c: c.data == "info")
async def show_info(callback: types.CallbackQuery):
    info_text = (
        "‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–∏—Å–µ:\n\n"
        "üì± –ß—Ç–æ –ø—Ä–æ–¥–∞–µ–º:\n"
        "‚Ä¢ –§–∏–∑–∏—á–µ—Å–∫–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è Telegram\n"
        "‚Ä¢ –†–∞–±–æ—á–∏–µ, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞\n"
        "‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7\n\n"
        "‚è±Ô∏è –°—Ä–æ–∫–∏:\n"
        "‚Ä¢ –î–æ—Å—Ç–∞–≤–∫–∞: 5-15 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã\n"
        f"‚Ä¢ —Ä–µ–≥: –≥–æ–¥ –Ω–∞–∑–∞–¥\n\n"
        "üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:\n"
        "‚Ä¢ –ù–æ–º–µ—Ä–∞ —Å–∫—Ä—ã—Ç—ã –æ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞\n"
        "‚Ä¢ –ü–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã\n"
        "‚Ä¢ –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–∫–∞–º–µ—Ä–æ–≤ –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è\n\n"
        "üí≥ –û–ø–ª–∞—Ç–∞:\n"
        f"‚Ä¢ –ü–µ—Ä–µ–≤–æ–¥–æ–º –Ω–∞ –∫–∞—Ä—Ç—É {CARD_NUMBER}\n"
        f"‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–æ–º: {AUTHOR_USERNAME}\n"
        "‚Ä¢ –í—ã–¥–∞—á–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è\n\n"
        "‚≠ê –°–∏—Å—Ç–µ–º–∞ –æ—Ç–∑—ã–≤–æ–≤:\n"
        "‚Ä¢ –û—Å—Ç–∞–≤–ª—è–π—Ç–µ –æ—Ç–∑—ã–≤—ã –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏\n"
        "‚Ä¢ –ü–æ–º–æ–≥–∞–π—Ç–µ –¥—Ä—É–≥–∏–º –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º\n\n"
        "üìä –û—Ç–∑—ã–≤—ã:\n"
        f"‚Ä¢ –¢–ì-–∫–∞–Ω–∞–ª: {CHANNEL_LINK}\n\n"
        "üë®‚Äçüíª –ê–≤—Ç–æ—Ä—ã:\n"
        f"‚Ä¢ {AUTHOR_USERNAME}"
    )
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="üì¢ –ö–∞–Ω–∞–ª —Å –æ—Ç–∑—ã–≤–∞–º–∏", url=CHANNEL_LINK))
    keyboard.add(InlineKeyboardButton(text="‚≠ê –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤", callback_data="leave_review"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        info_text,
        reply_markup=keyboard.as_markup()
    )

# –ê–ª—å—è–Ω—Å
@dp.callback_query(lambda c: c.data == "alliance")
async def show_alliance(callback: types.CallbackQuery):
    alliance_text = (
        "ü§ù –ê–ª—å—è–Ω—Å\n\n"
        "–ë–æ—Ç –±—ã–ª —Å–æ–∑–¥–∞–Ω —Å –ø–æ–º–æ—â—å—é:"
    )
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="@UGLYLELOOSH", url=f"https://t.me/{CREATOR_LINK[1:]}"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        alliance_text,
        reply_markup=keyboard.as_markup()
    )

# ==================== –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ ====================
@dp.callback_query(lambda c: c.data == "admin_panel")
async def admin_panel(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    keyboard = InlineKeyboardBuilder()
    
    keyboard.add(InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä", callback_data="admin_add_number_menu"))
    keyboard.add(InlineKeyboardButton(text="üìù –î–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä–æ–≤", callback_data="admin_add_multiple"))
    keyboard.add(InlineKeyboardButton(text="üí∞ –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É", callback_data="admin_edit_price_menu"))
    keyboard.add(InlineKeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats"))
    keyboard.add(InlineKeyboardButton(text="üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï –Ω–æ–º–µ—Ä–∞", callback_data="admin_clear_all"))
    keyboard.add(InlineKeyboardButton(text="üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –Ω–æ–º–µ—Ä–∞", callback_data="admin_show_all"))
    
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        "‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=keyboard.as_markup()
    )

# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –Ω–æ–º–µ—Ä–∞ –∞–¥–º–∏–Ω—É
@dp.callback_query(lambda c: c.data == "admin_show_all")
async def admin_show_all(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    data = load_numbers()
    
    if not data:
        await callback.message.answer("üì≠ –ë–∞–∑–∞ –Ω–æ–º–µ—Ä–æ–≤ –ø—É—Å—Ç–∞.")
        return
    
    text = "üìã –í—Å–µ –Ω–æ–º–µ—Ä–∞ –≤ –±–∞–∑–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞):\n\n"
    
    for country, info in data.items():
        text += f"üåç {country} ({info['price']}‚ÇΩ):\n"
        
        if not info["numbers"]:
            text += "   üì≠ –ù–µ—Ç –Ω–æ–º–µ—Ä–æ–≤\n\n"
            continue
        
        for num in info["numbers"]:
            status = "‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω" if not num.get("used", False) else "‚ùå –ü—Ä–æ–¥–∞–Ω"
            text += f"   üìû {num['number']} | {num['price']}‚ÇΩ | ID: {num['id']} | {status}\n"
        
        text += "\n"
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_panel"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(text[:4000], reply_markup=keyboard.as_markup())

# –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –Ω–æ–º–µ—Ä–∞
@dp.callback_query(lambda c: c.data == "admin_clear_all")
async def admin_clear_all(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–æ–º–µ—Ä–∞", callback_data="confirm_clear_all"))
    keyboard.add(InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="admin_panel"))
    keyboard.adjust(2)
    
    await callback.message.edit_text(
        "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n"
        "–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å –í–°–ï –Ω–æ–º–µ—Ä–∞ –∏–∑ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω.\n"
        "–ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ (–Ω–µ–ø—Ä–æ–¥–∞–Ω–Ω—ã–µ) –Ω–æ–º–µ—Ä–∞.\n"
        "–ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ.\n\n"
        "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data == "confirm_clear_all")
async def confirm_clear_all(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    data = load_numbers()
    
    cleared_count = 0
    for country in data:
        sold_numbers = [num for num in data[country]["numbers"] if num.get("used", False)]
        cleared_count += len(data[country]["numbers"]) - len(sold_numbers)
        data[country]["numbers"] = sold_numbers
    
    save_numbers(data)
    
    await callback.message.edit_text(
        f"‚úÖ –£–¥–∞–ª–µ–Ω–æ {cleared_count} –Ω–æ–º–µ—Ä–æ–≤!\n\n"
        "–í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ —É–¥–∞–ª–µ–Ω—ã.\n"
        "–ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏."
    )

# –ú–µ–Ω—é –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞
@dp.callback_query(lambda c: c.data == "admin_add_number_menu")
async def admin_add_number_menu(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    data = load_numbers()
    countries = list(data.keys())
    
    keyboard = InlineKeyboardBuilder()
    
    for country in countries:
        keyboard.add(InlineKeyboardButton(
            text=country,
            callback_data=f"admin_add_to_{country}"
        ))
    
    keyboard.add(InlineKeyboardButton(text="‚ûï –ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∞", callback_data="admin_new_country"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_panel"))
    
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        "üåç –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞:",
        reply_markup=keyboard.as_markup()
    )

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É
@dp.callback_query(lambda c: c.data.startswith("admin_add_to_"))
async def admin_add_to_country(callback: types.CallbackQuery, state: FSMContext):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    country = callback.data.split("_")[3]
    
    await state.set_state(AdminStates.adding_number)
    await state.update_data(country=country)
    
    await callback.message.edit_text(
        f"üìù –í–≤–µ–¥–∏—Ç–µ –†–ï–ê–õ–¨–ù–´–ô –Ω–æ–º–µ—Ä –¥–ª—è —Å—Ç—Ä–∞–Ω—ã {country} –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        f"+1234567890\n\n"
        f"üí° –î–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –Ω–æ–º–µ—Ä –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –∫–∞–∫: {format_phone_display(country, '+1234567890')}\n"
        f"üí∞ –¶–µ–Ω–∞ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ({load_numbers()[country]['price']}‚ÇΩ)"
    )

@dp.message(AdminStates.adding_number)
async def process_add_number(message: types.Message, state: FSMContext):
    user_data = await state.get_data()
    country = user_data.get('country')
    
    if not country:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞")
        await state.clear()
        return
    
    phone_number = message.text.strip()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
    if not (phone_number.startswith('+') and phone_number[1:].replace(' ', '').isdigit() and
                phone_number[1:].replace(' ', '').isdigit() and len(phone_number) > 5):
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ +1234567890")
        return
    
    data = load_numbers()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    for num in data[country]["numbers"]:
        if num["number"] == phone_number:
            await message.answer(f"‚ùå –ù–æ–º–µ—Ä {phone_number} —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ")
            return
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID
    if data[country]["numbers"]:
        new_id = max(num['id'] for num in data[country]["numbers"]) + 1
    else:
        new_id = 1
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä
    data[country]["numbers"].append({
        "id": new_id,
        "number": phone_number,
        "price": data[country]["price"],
        "used": False
    })
    
    save_numbers(data)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –Ω–æ–º–µ—Ä –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º
    display_number = format_phone_display(country, phone_number)
    
    await message.answer(
        f"‚úÖ –ù–æ–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω!\n\n"
        f"üåç –°—Ç—Ä–∞–Ω–∞: {country}\n"
        f"üìû –†–µ–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä: {phone_number}\n"
        f"üëÅÔ∏è –î–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π: {display_number}\n"
        f"üí∞ –¶–µ–Ω–∞: {data[country]['price']}‚ÇΩ\n"
        f"üÜî ID: {new_id}"
    )
    
    await state.clear()

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤
@dp.callback_query(lambda c: c.data == "admin_add_multiple")
async def admin_add_multiple_start(callback: types.CallbackQuery, state: FSMContext):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    data = load_numbers()
    countries = list(data.keys())
    
    keyboard = InlineKeyboardBuilder()
    
    for country in countries:
        keyboard.add(InlineKeyboardButton(
            text=country,
            callback_data=f"admin_multi_to_{country}"
        ))
    
    keyboard.add(InlineKeyboardButton(
        text="‚Ü©Ô∏è –ù–∞–∑–∞–¥",
        callback_data="admin_panel"
    ))
    
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        "üåç –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–æ–≤:\n\n"
        "üí° –ù–æ–º–µ—Ä–∞ –±—É–¥—É—Ç —Å–∫—Ä—ã—Ç—ã –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data.startswith("admin_multi_to_"))
async def admin_multi_to_country(callback: types.CallbackQuery, state: FSMContext):
    country = callback.data.split("_")[3]
    
    await state.set_state(AdminStates.adding_multiple_numbers)
    await state.update_data(country=country)
    
    await callback.message.edit_text(
        f"üìù –í–≤–µ–¥–∏—Ç–µ –†–ï–ê–õ–¨–ù–´–ï –Ω–æ–º–µ—Ä–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω—ã {country} –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É:\n"
        f"–§–æ—Ä–º–∞—Ç: +1234567890\n\n"
        f"–ü—Ä–∏–º–µ—Ä:\n"
        f"+8801112233\n"
        f"+8802223344\n"
        f"+8803334455\n\n"
        f"üí° –î–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –Ω–æ–º–µ—Ä–∞ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –∫–∞–∫: {format_phone_display(country, '+8800000000')}"
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤
@dp.message(AdminStates.adding_multiple_numbers)
async def process_multiple_numbers(message: types.Message, state: FSMContext):
    user_data = await state.get_data()
    country = user_data.get('country')
    
    if not country:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞")
        await state.clear()
        return
    
    phone_numbers = message.text.strip().split('\n')
    valid_numbers = []
    invalid_numbers = []
    
    for phone_number in phone_numbers:
        phone_number = phone_number.strip()
        if phone_number.startswith('+') and phone_number[1:].replace(' ', '').isdigit() and len(phone_number) > 5:
            valid_numbers.append(phone_number)
        else:
            invalid_numbers.append(phone_number)
    
    if not valid_numbers:
        await message.answer("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–∞–ª–∏–¥–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞")
        return
    
    data = load_numbers()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    existing_numbers = [num["number"] for num in data[country]["numbers"]]
    duplicates = []
    unique_numbers = []
    
    for phone_number in valid_numbers:
        if phone_number in existing_numbers:
            duplicates.append(phone_number)
        else:
            unique_numbers.append(phone_number)
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID
    if data[country]["numbers"]:
        current_id = max(num['id'] for num in data[country]["numbers"])
    else:
        current_id = 0
    
    added_count = 0
    for phone_number in unique_numbers:
        current_id += 1
        data[country]["numbers"].append({
            "id": current_id,
            "number": phone_number,
            "price": data[country]["price"],
            "used": False
        })
        added_count += 1
    
    save_numbers(data)
    
    response = f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ {added_count} –Ω–æ–º–µ—Ä–æ–≤ –≤ —Å—Ç—Ä–∞–Ω—É {country}\n\n"
    
    # –ü—Ä–∏–º–µ—Ä –∫–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π
    if unique_numbers:
        sample_display = format_phone_display(country, unique_numbers[0])
        response += f"üí° –î–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –Ω–æ–º–µ—Ä–∞ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –∫–∞–∫: {sample_display}\n\n"
    
    if duplicates:
        response += f"‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ (–¥—É–±–ª–∏–∫–∞—Ç—ã): {len(duplicates)} –Ω–æ–º–µ—Ä–æ–≤\n"
        for dup in duplicates[:3]:
            response += f"   {dup}\n"
        if len(duplicates) > 3:
            response += f"   ... –∏ –µ—â–µ {len(duplicates) - 3}\n"
        response += "\n"
    
    if invalid_numbers:
        response += f"‚ùå –ù–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ (–Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç): {len(invalid_numbers)} –Ω–æ–º–µ—Ä–æ–≤\n"
        for invalid in invalid_numbers[:3]:
            response += f"   {invalid}\n"
        if len(invalid_numbers) > 3:
            response += f"   ... –∏ –µ—â–µ {len(invalid_numbers) - 3}\n"
    
    await message.answer(response)
    await state.clear()

# –ú–µ–Ω—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã
@dp.callback_query(lambda c: c.data == "admin_edit_price_menu")
async def admin_edit_price_menu(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    data = load_numbers()
    countries = list(data.keys())
    
    keyboard = InlineKeyboardBuilder()
    
    for country in countries:
        keyboard.add(InlineKeyboardButton(
            text=f"{country} - {data[country]['price']}‚ÇΩ",
            callback_data=f"admin_edit_price_{country}"
        ))
    
    keyboard.add(InlineKeyboardButton(
        text="‚Ü©Ô∏è –ù–∞–∑–∞–¥",
        callback_data="admin_panel"
    ))
    
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        "üí∞ –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã:",
        reply_markup=keyboard.as_markup()
    )

# –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã
@dp.callback_query(lambda c: c.data.startswith("admin_edit_price_"))
async def admin_edit_price(callback: types.CallbackQuery, state: FSMContext):
    country = callback.data.split("_")[3]
    
    await state.set_state(AdminStates.editing_price)
    await state.update_data(country=country)
    
    current_price = load_numbers()[country]["price"]
    
    await callback.message.edit_text(
        f"üí∞ –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –¥–ª—è {country}: {current_price}‚ÇΩ\n\n"
        f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ):"
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–π —Ü–µ–Ω—ã
@dp.message(AdminStates.editing_price)
async def process_edit_price(message: types.Message, state: FSMContext):
    user_data = await state.get_data()
    country = user_data.get('country')
    
    try:
        new_price = int(message.text.strip())
        
        if new_price <= 0:
            await message.answer("‚ùå –¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0")
            return
        
        data = load_numbers()
        
        if country not in data:
            await message.answer("‚ùå –°—Ç—Ä–∞–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return
        
        data[country]["price"] = new_price
        
        for num in data[country]["numbers"]:
            if not num.get("used", False):
                num["price"] = new_price
        
        save_numbers(data)
        
        await message.answer(f"‚úÖ –¶–µ–Ω–∞ –¥–ª—è {country} –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ {new_price}‚ÇΩ")
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ")
        return
    
    await state.clear()

# –ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∞
@dp.callback_query(lambda c: c.data == "admin_new_country")
async def admin_new_country(callback: types.CallbackQuery, state: FSMContext):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    await state.set_state(AdminStates.adding_country)
    
    await callback.message.edit_text(
        "üåç –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω—ã –∏ —Ü–µ–Ω—É —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:\n"
        "–ü—Ä–∏–º–µ—Ä: –ë—Ä–∞–∑–∏–ª–∏—è,150\n\n"
        "üí° –î–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –Ω–æ–º–µ—Ä–∞ –±—É–¥—É—Ç —Å–∫—Ä—ã—Ç—ã"
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω—ã
@dp.message(AdminStates.adding_country)
async def process_new_country(message: types.Message, state: FSMContext):
    try:
        country, price = message.text.split(',')
        country = country.strip()
        price = int(price.strip())
        
        data = load_numbers()
        
        if country in data:
            await message.answer(f"‚ùå –°—Ç—Ä–∞–Ω–∞ {country} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            return
        
        data[country] = {
            "price": price,
            "numbers": []
        }
        
        save_numbers(data)
        
        await message.answer(
            f"‚úÖ –°—Ç—Ä–∞–Ω–∞ {country} —Å–æ–∑–¥–∞–Ω–∞ —Å —Ü–µ–Ω–æ–π {price}‚ÇΩ\n\n"
            f"üí° –î–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –Ω–æ–º–µ—Ä–∞ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –∫–∞–∫: {format_phone_display(country, '+1234567890')}\n\n"
            f"–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–º–µ—Ä–∞ –≤ —ç—Ç—É —Å—Ç—Ä–∞–Ω—É —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å."
        )
        await state.clear()
        
    except ValueError:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: –°—Ç—Ä–∞–Ω–∞,—Ü–µ–Ω–∞")

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
@dp.callback_query(lambda c: c.data == "admin_stats")
async def admin_stats(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    data = load_numbers()
    pending_orders = load_pending_orders()
    reviews_data = load_reviews()
    
    stats_text = "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n\n"
    
    total_numbers = 0
    total_available = 0
    total_sold = 0
    total_value = 0
    
    for country, info in data.items():
        numbers = info["numbers"]
        available = sum(1 for num in numbers if not num.get("used", False))
        sold = len(numbers) - available
        
        stats_text += f"üåç {country}:\n"
        stats_text += f"   ‚Ä¢ –¶–µ–Ω–∞: {info['price']}‚ÇΩ\n"
        stats_text += f"   ‚Ä¢ –í—Å–µ–≥–æ: {len(numbers)} —à—Ç.\n"
        stats_text += f"   ‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ: {available} —à—Ç.\n"
        stats_text += f"   ‚Ä¢ –ü—Ä–æ–¥–∞–Ω–æ: {sold} —à—Ç.\n"
        stats_text += f"   ‚Ä¢ –í—ã—Ä—É—á–∫–∞: {sold * info['price']}‚ÇΩ\n\n"
        
        total_numbers += len(numbers)
        total_available += available
        total_sold += sold
        total_value += sold * info['price']
    
    stats_text += f"üìà –ò—Ç–æ–≥–æ:\n"
    stats_text += f"   ‚Ä¢ –í—Å–µ–≥–æ –Ω–æ–º–µ—Ä–æ–≤: {total_numbers} —à—Ç.\n"
    stats_text += f"   ‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ: {total_available} —à—Ç.\n"
    stats_text += f"   ‚Ä¢ –ü—Ä–æ–¥–∞–Ω–æ: {total_sold} —à—Ç.\n"
    stats_text += f"   ‚Ä¢ –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: {total_value}‚ÇΩ\n"
    stats_text += f"   ‚Ä¢ –°—Ç—Ä–∞–Ω—ã: {len(data)}\n\n"
    
    stats_text += f"üîÑ –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:\n"
    stats_text += f"   ‚Ä¢ –û–∂–∏–¥–∞—é—Ç –≤—ã–¥–∞—á–∏: {len(pending_orders)} –∑–∞–∫–∞–∑(–æ–≤)\n"
    stats_text += f"   ‚Ä¢ –û—Ç–∑—ã–≤–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ: {len(reviews_data.get('reviews', []))}\n"
    stats_text += f"   ‚Ä¢ üîí –ù–æ–º–µ—Ä–∞ —Å–∫—Ä—ã—Ç—ã –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π\n"
    
    reviews = reviews_data.get("reviews", [])
    if reviews:
        avg_rating = sum(r.get("rating", 5) for r in reviews) / len(reviews)
        stats_text += f"   ‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: {avg_rating:.1f}/5 ‚≠ê"
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="admin_stats"))
    keyboard.add(InlineKeyboardButton(text="üìã –û–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã", callback_data="show_pending_orders"))
    keyboard.add(InlineKeyboardButton(text="‚≠ê –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã", callback_data="reviews"))
    keyboard.add(InlineKeyboardButton(text="üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –Ω–æ–º–µ—Ä–∞", callback_data="admin_show_all"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_panel"))
    keyboard.adjust(2, 1, 1, 1)
    
    await callback.message.edit_text(
        stats_text,
        reply_markup=keyboard.as_markup()
    )

# –ü–æ–∫–∞–∑–∞—Ç—å –æ–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã
@dp.callback_query(lambda c: c.data == "show_pending_orders")
async def show_pending_orders(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    pending_orders = load_pending_orders()
    
    if not pending_orders:
        await callback.message.answer("‚úÖ –ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤.")
        return
    
    text = "üîÑ –ó–∞–∫–∞–∑—ã, –æ–∂–∏–¥–∞—é—â–∏–µ –≤—ã–¥–∞—á–∏:\n\n"
    
    for order_id, order_info in list(pending_orders.items())[:10]:
        user_info = f"@{order_info['username']}" if order_info['username'] else f"ID: {order_info['user_id']}"
        date = datetime.fromisoformat(order_info['selected_at']).strftime("%H:%M")
        
        text += f"üÜî {order_id[:8]}...\n"
        text += f"üë§ {user_info}\n"
        text += f"üåç {order_info['country']}\n"
        text += f"üìû (–ø–æ–∫—É–ø–∞—Ç–µ–ª—é): {order_info['display_number']}\n"
        text += f"üìû (—Ä–µ–∞–ª—å–Ω—ã–π): {order_info['actual_number']}\n"
        text += f"üí∞ {order_info['price']}‚ÇΩ | üïí {date}\n\n"
        
        keyboard = InlineKeyboardBuilder()
        keyboard.add(InlineKeyboardButton(
            text=f"‚úÖ –í—ã–¥–∞—Ç—å {order_id[:8]}...",
            callback_data=f"confirm_delivery_{order_id}"
        ))
        keyboard.add(InlineKeyboardButton(
            text=f"‚ùå –û—Ç–º–µ–Ω–∏—Ç—å {order_id[:8]}...",
            callback_data=f"cancel_delivery_{order_id}"
        ))
        keyboard.adjust(1)
        
        await callback.message.answer(text, reply_markup=keyboard.as_markup())
        text = ""
    
    keyboard_back = InlineKeyboardBuilder()
    keyboard_back.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É", callback_data="admin_stats"))
    keyboard_back.adjust(1)
    
    if len(pending_orders) > 10:
        await callback.message.answer(
            f"üìã ... –∏ –µ—â–µ {len(pending_orders) - 10} –∑–∞–∫–∞–∑–æ–≤",
            reply_markup=keyboard_back.as_markup()
        )
    else:
        await callback.message.answer(
            "üìã –ö–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞",
            reply_markup=keyboard_back.as_markup()
        )

# –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
@dp.callback_query(lambda c: c.data == "back_to_main")
async def back_to_main(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    await cmd_start(callback.message)

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
@dp.message(Command("reset"))
async def cmd_reset(message: types.Message):
    if message.from_user.id != ADMIN_ID:
        await message.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="‚úÖ –î–∞, —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ", callback_data="confirm_reset"))
    keyboard.add(InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="admin_panel"))
    keyboard.adjust(2)
    
    await message.answer(
        "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n"
        "–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å –í–°–ï –Ω–æ–º–µ—Ä–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.\n"
        "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!\n\n"
        "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data == "confirm_reset")
async def confirm_reset(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    clean_data = {
        "–ë–∞–Ω–≥–ª–∞–¥–µ—à": {"price": 120, "numbers": []},
        "–í—å–µ—Ç–Ω–∞–º": {"price": 115, "numbers": []},
        "–ò–Ω–¥–∏—è": {"price": 100, "numbers": []},
        "–ú—å—è–Ω–º–∞": {"price": 130, "numbers": []}
    }
    
    save_numbers(clean_data)
    save_pending_orders({})
    
    await callback.message.edit_text(
        "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω–∞!\n"
        "–í—Å–µ –Ω–æ–º–µ—Ä–∞ —É–¥–∞–ª–µ–Ω—ã.\n"
        "–û–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã –æ—á–∏—â–µ–Ω—ã.\n\n"
        "–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å."
    )

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
async def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    init_data()
    
    print("=" * 60)
    print("ü§ñ –ë–û–¢ –ó–ê–ü–£–©–ï–ù –° –°–ö–†–´–¢–´–ú–ò –ù–û–ú–ï–†–ê–ú–ò!")
    print("=" * 60)
    print(f"üëë –ê–¥–º–∏–Ω ID: {ADMIN_ID}")
    print(f"üë§ –ê–≤—Ç–æ—Ä ID: {AUTHOR_ID}")
    print(f"üí≥ –ö–∞—Ä—Ç–∞: {CARD_NUMBER[:8]}****")
    print(f"üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞: {SUPPORT_USERNAME}")
    print("=" * 60)
    print("‚ú® –û–°–û–ë–ï–ù–ù–û–°–¢–ò:")
    print("1. üîí –ù–æ–º–µ—Ä–∞ —Å–∫—Ä—ã—Ç—ã –æ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞")
    print("2. ‚úÖ –ü–æ–∫—É–ø–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã")
    print("3. üì± –†–µ–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã")
    print("4. ‚≠ê –°–∏—Å—Ç–µ–º–∞ –æ—Ç–∑—ã–≤–æ–≤ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º")
    print("5. üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É —Å –∫–Ω–æ–ø–∫–∞–º–∏")
    print("=" * 60)
    print("üíµ –û–ø–ª–∞—Ç–∞: –†–£–ë–õ–Ø–ú–ò –ø–æ –∫–∞—Ä—Ç–µ")
    print("üì± –°—Ç–∞—Ç—É—Å: –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    
    try:
        await dp.start_polling(bot)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: {e}")

if __name__ == "__main__":
    asyncio.run(main())
