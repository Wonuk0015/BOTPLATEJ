import asyncio
import logging
import json
import os
import sys
import random
from datetime import datetime
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.memory import MemoryStorage

# ==================== –ù–ê–°–¢–†–û–ô–ö–ê ====================
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
BOT_TOKEN = "8156674134:AAH2t8wCtxo95-_t3HQUFaOMBBHVPMWdQaU"  # –í–∞—à —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
ADMIN_ID = 1978558036  # ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–¥—Ä—É–≥–∞)
AUTHOR_ID = 951154134  # ID –∞–≤—Ç–æ—Ä–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ—Ç –∂–µ, —á—Ç–æ –∏ –∞–¥–º–∏–Ω)

# –ö–æ–Ω—Ç–∞–∫—Ç—ã
SUPPORT_USERNAME = "@svetonaya"
AUTHOR_USERNAME = "@svetonaya"  # –ê–≤—Ç–æ—Ä –¥–ª—è –≤—ã–¥–∞—á–∏ –Ω–æ–º–µ—Ä–æ–≤
CHANNEL_LINK = "https://t.me/shopsfiznumber"
CREATOR_LINK = "@UGLYLELOOSH"

# –†–µ–∫–≤–∏–∑–∏—Ç—ã –∫–∞—Ä—Ç—ã (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò!)
CARD_NUMBER = "2200 1234 5678 9012"  # –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã
CARD_HOLDER = "–ò–í–ê–ù –ò–í–ê–ù–û–í"           # –ò–º—è –¥–µ—Ä–∂–∞—Ç–µ–ª—è

# –§–∞–π–ª—ã –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
DATA_FILE = "numbers.json"
REVIEWS_FILE = "reviews.json"
PENDING_ORDERS_FILE = "pending_orders.json"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
if not BOT_TOKEN:
    logger.error("‚ùå –û–®–ò–ë–ö–ê: BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    sys.exit(1)

# ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
bot = Bot(token=BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# –ö–æ–¥—ã —Å—Ç—Ä–∞–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
COUNTRY_CODES = {
    "–ë–∞–Ω–≥–ª–∞–¥–µ—à": "+880",
    "–í—å–µ—Ç–Ω–∞–º": "+84", 
    "–ò–Ω–¥–∏—è": "+91",
    "–ú—å—è–Ω–º–∞": "+95",
    "–†–æ—Å—Å–∏—è": "+7",
    "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω": "+7",
    "–£–∫—Ä–∞–∏–Ω–∞": "+380",
    "–ë–µ–ª–∞—Ä—É—Å—å": "+375",
    "–°–®–ê": "+1",
    "–ö–∞–Ω–∞–¥–∞": "+1",
    "–ì–µ—Ä–º–∞–Ω–∏—è": "+49",
    "–§—Ä–∞–Ω—Ü–∏—è": "+33",
    "–ò—Ç–∞–ª–∏—è": "+39",
    "–ò—Å–ø–∞–Ω–∏—è": "+34",
    "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è": "+44",
    "–ü–æ–ª—å—à–∞": "+48",
    "–¢—É—Ä—Ü–∏—è": "+90",
    "–ö–∏—Ç–∞–π": "+86",
    "–Ø–ø–æ–Ω–∏—è": "+81",
    "–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è": "+82",
    "–ê–≤—Å—Ç—Ä–∞–ª–∏—è": "+61",
    "–ë—Ä–∞–∑–∏–ª–∏—è": "+55",
    "–ú–µ–∫—Å–∏–∫–∞": "+52"
}

# ==================== –°–û–°–¢–û–Ø–ù–ò–Ø FSM ====================
class AdminStates(StatesGroup):
    adding_country = State()
    adding_quantity = State()
    editing_price = State()
    waiting_review = State()

# ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –î–ê–ù–ù–´–ú–ò ====================
def load_numbers():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–æ–º–µ—Ä–∞ –∏–∑ —Ñ–∞–π–ª–∞"""
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {}
    return {}

def save_numbers(data):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–º–µ—Ä–∞ –≤ —Ñ–∞–π–ª"""
    with open(DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

def load_reviews():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –æ—Ç–∑—ã–≤—ã –∏–∑ —Ñ–∞–π–ª–∞"""
    if os.path.exists(REVIEWS_FILE):
        try:
            with open(REVIEWS_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {"reviews": []}
    return {"reviews": []}

def save_reviews(data):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–∑—ã–≤—ã –≤ —Ñ–∞–π–ª"""
    with open(REVIEWS_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

def load_pending_orders():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –æ–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã"""
    if os.path.exists(PENDING_ORDERS_FILE):
        try:
            with open(PENDING_ORDERS_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {}
    return {}

def save_pending_orders(data):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã"""
    with open(PENDING_ORDERS_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

def init_data():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
    data = load_numbers()
    if not data:
        initial_data = {
            "–†–æ—Å—Å–∏—è": {
                "price": 100,
                "quantity": 0,
                "code": "+7"
            },
            "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω": {
                "price": 120,
                "quantity": 0,
                "code": "+7"
            },
            "–£–∫—Ä–∞–∏–Ω–∞": {
                "price": 130,
                "quantity": 0,
                "code": "+380"
            },
            "–ë–µ–ª–∞—Ä—É—Å—å": {
                "price": 140,
                "quantity": 0,
                "code": "+375"
            },
            "–°–®–ê": {
                "price": 200,
                "quantity": 0,
                "code": "+1"
            }
        }
        save_numbers(initial_data)
        logger.info("‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö")
    
    if not os.path.exists(REVIEWS_FILE):
        save_reviews({"reviews": []})
    
    if not os.path.exists(PENDING_ORDERS_FILE):
        save_pending_orders({})
    
    return data

# ==================== –§–£–ù–ö–¶–ò–Ø 1: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–¥–∞—á–∏ —Ç–æ–≤–∞—Ä–∞ ====================
@dp.callback_query(lambda c: c.data.startswith("confirm_delivery_"))
async def confirm_delivery(callback: types.CallbackQuery):
    """–ê–≤—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –≤—ã–¥–∞—á—É —Ç–æ–≤–∞—Ä–∞"""
    if callback.from_user.id != AUTHOR_ID:
        await callback.answer("‚ùå –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å –≤—ã–¥–∞—á—É")
        return
    
    order_id = callback.data.split("_")[2]
    pending_orders = load_pending_orders()
    
    if order_id not in pending_orders:
        await callback.answer("‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    order_info = pending_orders[order_id]
    country = order_info["country"]
    
    # –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
    data = load_numbers()
    
    if country in data and data[country]["quantity"] > 0:
        data[country]["quantity"] -= 1
        save_numbers(data)
    else:
        await callback.answer("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –≤ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–µ")
        return
    
    # –£–¥–∞–ª—è–µ–º –∑–∞–∫–∞–∑ –∏–∑ –æ–∂–∏–¥–∞—é—â–∏—Ö
    del pending_orders[order_id]
    save_pending_orders(pending_orders)
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
    try:
        buyer_id = order_info["user_id"]
        await bot.send_message(
            buyer_id,
            f"‚úÖ –ê–≤—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤—ã–¥–∞—á—É –Ω–æ–º–µ—Ä–∞!\n\n"
            f"üåç –°—Ç—Ä–∞–Ω–∞: {country}\n"
            f"üìû –ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã: {data[country]['code']}\n"
            f"üí∞ –¶–µ–Ω–∞: {order_info['price']}‚ÇΩ\n\n"
            f"üéâ –ê–≤—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ø–æ–ª–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞!\n\n"
            f"üí¨ –°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–≤—Ç–æ—Ä–æ–º: {AUTHOR_USERNAME}\n\n"
            f"‚≠ê –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤!",
            parse_mode="HTML"
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è: {e}")
    
    await callback.message.edit_text(
        f"‚úÖ –í—ã–¥–∞—á–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!\n\n"
        f"üåç –°—Ç—Ä–∞–Ω–∞: {country}\n"
        f"üìû –ö–æ–¥: {data[country]['code']}\n"
        f"üí∞ –¶–µ–Ω–∞: {order_info['price']}‚ÇΩ\n"
        f"üë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω.\n"
        f"üìû –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–º –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–æ–º–µ—Ä–∞."
    )
    
    logger.info(f"–ê–≤—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤—ã–¥–∞—á—É –∑–∞–∫–∞–∑–∞ {order_id}")

@dp.callback_query(lambda c: c.data.startswith("cancel_delivery_"))
async def cancel_delivery(callback: types.CallbackQuery):
    """–ê–≤—Ç–æ—Ä –æ—Ç–º–µ–Ω—è–µ—Ç –≤—ã–¥–∞—á—É (–æ—Ç–∫–∞–∑ –∑–∞–∫–∞–∑–∞)"""
    if callback.from_user.id != AUTHOR_ID:
        await callback.answer("‚ùå –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω—è—Ç—å –∑–∞–∫–∞–∑—ã")
        return
    
    order_id = callback.data.split("_")[2]
    pending_orders = load_pending_orders()
    
    if order_id in pending_orders:
        del pending_orders[order_id]
        save_pending_orders(pending_orders)
    
    await callback.message.edit_text(
        "‚ùå –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω.\n"
        "–ù–æ–º–µ—Ä –æ—Å—Ç–∞–ª—Å—è –≤ –ø—Ä–æ–¥–∞–∂–µ."
    )
    
    await admin_panel(callback)

# ==================== –§–£–ù–ö–¶–ò–Ø 2: –°–∏—Å—Ç–µ–º–∞ –æ—Ç–∑—ã–≤–æ–≤ ====================
@dp.callback_query(lambda c: c.data == "reviews")
async def show_reviews(callback: types.CallbackQuery):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–∑—ã–≤—ã"""
    reviews_data = load_reviews()
    reviews = reviews_data.get("reviews", [])
    
    if not reviews:
        await callback.message.answer("üì≠ –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!")
        return
    
    recent_reviews = reviews[-5:]
    
    text = "‚≠ê –û—Ç–∑—ã–≤—ã –Ω–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤:\n\n"
    
    for i, review in enumerate(recent_reviews, 1):
        user_info = review.get("username", f"ID: {review.get('user_id', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}")
        rating = "‚≠ê" * min(5, int(review.get("rating", 5)))
        date = datetime.fromisoformat(review.get("date", datetime.now().isoformat())).strftime("%d.%m.%Y")
        
        text += f"{i}. {user_info}\n"
        text += f"   {rating}\n"
        if review.get("comment"):
            text += f"   üí¨ {review.get('comment')[:50]}"
            if len(review.get("comment", "")) > 50:
                text += "..."
        text += f"\n   üìÖ {date}\n\n"
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="üí¨ –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤", callback_data="leave_review"))
    keyboard.add(InlineKeyboardButton(text="üì¢ –í—Å–µ –æ—Ç–∑—ã–≤—ã –≤ –∫–∞–Ω–∞–ª–µ", url=CHANNEL_LINK))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(text, reply_markup=keyboard.as_markup())

@dp.callback_query(lambda c: c.data == "leave_review")
async def leave_review_start(callback: types.CallbackQuery, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞"""
    await state.set_state(AdminStates.waiting_review)
    
    keyboard = InlineKeyboardBuilder()
    for i in range(1, 6):
        keyboard.add(InlineKeyboardButton(text="‚≠ê" * i, callback_data=f"rating_{i}"))
    keyboard.add(InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="reviews"))
    keyboard.adjust(3, 2)
    
    await callback.message.edit_text(
        "üí¨ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ü–µ–Ω–∏—Ç–µ –Ω–∞—à —Å–µ—Ä–≤–∏—Å:\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥ –æ—Ç 1 –¥–æ 5:",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data.startswith("rating_"))
async def set_rating(callback: types.CallbackQuery, state: FSMContext):
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞"""
    rating = int(callback.data.split("_")[1])
    await state.update_data(rating=rating)
    
    await callback.message.edit_text(
        f"‚≠ê –í—ã –æ—Ü–µ–Ω–∏–ª–∏ –Ω–∞ {rating}/5\n\n"
        f"–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'):\n\n"
        f"üìù –ù–∞–ø–∏—à–∏—Ç–µ '–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å' —á—Ç–æ–±—ã –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
    )

@dp.message(AdminStates.waiting_review)
async def process_review_comment(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∫ –æ—Ç–∑—ã–≤—É"""
    user_data = await state.get_data()
    rating = user_data.get("rating", 5)
    comment = message.text if message.text.lower() != "–ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å" else ""
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∑—ã–≤
    reviews_data = load_reviews()
    review = {
        "user_id": message.from_user.id,
        "username": f"@{message.from_user.username}" if message.from_user.username else f"ID: {message.from_user.id}",
        "rating": rating,
        "comment": comment,
        "date": datetime.now().isoformat()
    }
    reviews_data["reviews"].append(review)
    save_reviews(reviews_data)
    
    if comment:
        response = f"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤!\n–†–µ–π—Ç–∏–Ω–≥: {'‚≠ê' * rating}\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω."
    else:
        response = f"‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ü–µ–Ω–∫—É!\n–†–µ–π—Ç–∏–Ω–≥: {'‚≠ê' * rating}"
    
    await message.answer(response)
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞ –æ –Ω–æ–≤–æ–º –æ—Ç–∑—ã–≤–µ
    try:
        await bot.send_message(
            ADMIN_ID,
            f"üì£ –ù–û–í–´–ô –û–¢–ó–´–í!\n\n"
            f"üë§ –û—Ç: {review['username']}\n"
            f"‚≠ê –†–µ–π—Ç–∏–Ω–≥: {'‚≠ê' * rating}\n"
            f"üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {comment[:100]}{'...' if len(comment) > 100 else '' if comment else '–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}"
        )
    except:
        pass
    
    await state.clear()

# ==================== –§–£–ù–ö–¶–ò–Ø 3: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É ====================
async def notify_admin_about_selection(user_id: int, username: str, country: str, price: int):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–¥–º–∏–Ω—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—ã–±–æ—Ä–µ –Ω–æ–º–µ—Ä–∞"""
    try:
        user_info = f"@{username}" if username else f"ID: {user_id}"
        data = load_numbers()
        country_code = data[country]["code"] if country in data else COUNTRY_CODES.get(country, "")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ
        order_id = f"{user_id}_{int(datetime.now().timestamp())}"
        pending_orders = load_pending_orders()
        
        pending_orders[order_id] = {
            "user_id": user_id,
            "username": username,
            "country": country,
            "code": country_code,
            "price": price,
            "selected_at": datetime.now().isoformat()
        }
        save_pending_orders(pending_orders)
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏
        keyboard = InlineKeyboardBuilder()
        keyboard.add(InlineKeyboardButton(
            text="‚úÖ –ù–æ–º–µ—Ä –±—ã–ª –≤—ã–¥–∞–Ω",
            callback_data=f"confirm_delivery_{order_id}"
        ))
        keyboard.add(InlineKeyboardButton(
            text="‚ùå –û—Ç–∫–∞–∑ –∑–∞–∫–∞–∑–∞",
            callback_data=f"cancel_delivery_{order_id}"
        ))
        keyboard.adjust(1)
        
        message_text = (
            f"üéØ –ù–û–í–´–ô –ó–ê–ö–ê–ó!\n\n"
            f"üë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å: {user_info}\n"
            f"üåç –°—Ç—Ä–∞–Ω–∞: {country}\n"
            f"üìû –ö–æ–¥: {country_code}\n"
            f"üí∞ –¶–µ–Ω–∞: {price}‚ÇΩ\n"
            f"üÜî ID –∑–∞–∫–∞–∑–∞: {order_id[:8]}\n"
            f"üïí –í—Ä–µ–º—è: {datetime.now().strftime('%H:%M:%S')}"
        )
        
        await bot.send_message(
            ADMIN_ID,
            message_text,
            parse_mode="Markdown",
            reply_markup=keyboard.as_markup()
        )
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞: {e}")

# ==================== –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´ –ë–û–¢–ê ====================
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    keyboard = InlineKeyboardBuilder()
    
    keyboard.add(InlineKeyboardButton(text="üì± –ö—É–ø–∏—Ç—å –Ω–æ–º–µ—Ä", callback_data="buy_number"))
    keyboard.add(InlineKeyboardButton(text="‚≠ê –û—Ç–∑—ã–≤—ã", callback_data="reviews"))
    keyboard.add(InlineKeyboardButton(text="‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data="info"))
    keyboard.add(InlineKeyboardButton(text="ü§ù –ê–ª—å—è–Ω—Å", callback_data="alliance"))
    keyboard.add(InlineKeyboardButton(text="üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞", url=f"https://t.me/{SUPPORT_USERNAME[1:]}"))
    
    if message.from_user.id == ADMIN_ID:
        keyboard.add(InlineKeyboardButton(text="‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_panel"))
    
    keyboard.adjust(1)
    
    await message.answer(
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–µ —Ñ–∏–∑ –Ω–æ–º–µ—Ä–æ–≤!\n\n"
        "üì± –ù–æ–º–µ—Ä–∞ –≤—ã–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ—Ä–æ–º –≤—Ä—É—á–Ω—É—é.\n"
        "üîí –í—ã–±–∏—Ä–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω—É ‚Üí –û–ø–ª–∞—á–∏–≤–∞–π—Ç–µ ‚Üí –ü–æ–ª—É—á–∞–π—Ç–µ –Ω–æ–º–µ—Ä –æ—Ç –∞–≤—Ç–æ—Ä–∞!\n\n"
        "üõí –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data == "buy_number")
async def show_countries(callback: types.CallbackQuery):
    data = load_numbers()
    
    if not data:
        await callback.message.answer("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤.")
        return
    
    keyboard = InlineKeyboardBuilder()
    
    for country, info in data.items():
        if info["quantity"] > 0:
            keyboard.add(InlineKeyboardButton(
                text=f"üìç {country} ({info['quantity']} —à—Ç.) - {info['price']}‚ÇΩ",
                callback_data=f"country_{country}"
            ))
    
    keyboard.add(InlineKeyboardButton(text="‚≠ê –û—Ç–∑—ã–≤—ã", callback_data="reviews"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        "üåç –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –Ω–æ–º–µ—Ä–∞:\n"
        "üì± –ù–æ–º–µ—Ä–∞ –≤—ã–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ—Ä–æ–º –≤—Ä—É—á–Ω—É—é –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã\n"
        "(–≤ —Å–∫–æ–±–∫–∞—Ö —É–∫–∞–∑–∞–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤)",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data.startswith("country_"))
async def select_country_for_purchase(callback: types.CallbackQuery):
    country = callback.data.split("_")[1]
    data = load_numbers()
    
    if country not in data:
        await callback.answer("‚ùå –°—Ç—Ä–∞–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    country_info = data[country]
    
    if country_info["quantity"] <= 0:
        await callback.answer("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤")
        return
    
    payment_text = (
        f"‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏:\n\n"
        f"üåç –°—Ç—Ä–∞–Ω–∞: {country}\n"
        f"üìû –ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã: {country_info['code']}\n"
        f"üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: {country_info['price']}‚ÇΩ\n"
        f"üìä –î–æ—Å—Ç—É–ø–Ω–æ: {country_info['quantity']} —à—Ç.\n\n"
        f"üí≥ –û–ø–ª–∞—Ç–∞ –ø–æ –∫–∞—Ä—Ç–µ:\n\n"
        f"1. –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ {country_info['price']}‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É:\n"
        f"   üí≥ {CARD_NUMBER}\n"
        f"   üë§ {CARD_HOLDER}\n\n"
        f"2. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞:\n"
        f"   üì® {AUTHOR_USERNAME}\n\n"
        f"3. –ê–≤—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø–ª–∞—Ç–µ–∂ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –ü–û–õ–ù–´–ô –Ω–æ–º–µ—Ä\n\n"
        f"‚ö†Ô∏è –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:\n"
        f"   –ü–æ–∫—É–ø–∫–∞ {country} –Ω–æ–º–µ—Ä–∞\n\n"
        f"üîí –ù–æ–º–µ—Ä –≤—ã–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–æ–º –≤—Ä—É—á–Ω—É—é –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã."
    )
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(
        text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–∫—É–ø–∫—É", 
        callback_data=f"confirm_purchase_{country}"
    ))
    keyboard.add(InlineKeyboardButton(
        text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç—Ä–∞–Ω–∞–º", 
        callback_data="buy_number"
    ))
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        payment_text,
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data.startswith("confirm_purchase_"))
async def confirm_purchase(callback: types.CallbackQuery):
    country = callback.data.split("_")[2]
    data = load_numbers()
    
    if country not in data:
        await callback.answer("‚ùå –°—Ç—Ä–∞–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    country_info = data[country]
    
    if country_info["quantity"] <= 0:
        await callback.answer("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤")
        return
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞ –æ –≤—ã–±–æ—Ä–µ
    await notify_admin_about_selection(
        user_id=callback.from_user.id,
        username=callback.from_user.username,
        country=country,
        price=country_info['price']
    )
    
    await callback.message.edit_text(
        f"üéâ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!\n\n"
        f"üåç –°—Ç—Ä–∞–Ω–∞: {country}\n"
        f"üìû –ö–æ–¥: {country_info['code']}\n"
        f"üí∞ –¶–µ–Ω–∞: {country_info['price']}‚ÇΩ\n\n"
        f"üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:\n"
        f"1. –û–ø–ª–∞—Ç–∏—Ç–µ {country_info['price']}‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É {CARD_NUMBER}\n"
        f"2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞ –∞–≤—Ç–æ—Ä—É: {AUTHOR_USERNAME}\n"
        f"3. –ê–≤—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –≤–∞–º –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä\n\n"
        f"‚è≥ –û–±—ã—á–Ω–æ –≤—ã–¥–∞—á–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 5-15 –º–∏–Ω—É—Ç\n\n"
        f"üí¨ –ö–æ–Ω—Ç–∞–∫—Ç –∞–≤—Ç–æ—Ä–∞: {AUTHOR_USERNAME}\n"
        f"üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞: {SUPPORT_USERNAME}"
    )

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
@dp.callback_query(lambda c: c.data == "info")
async def show_info(callback: types.CallbackQuery):
    info_text = (
        "‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–∏—Å–µ:\n\n"
        "üì± –ß—Ç–æ –ø—Ä–æ–¥–∞–µ–º:\n"
        "‚Ä¢ –§–∏–∑–∏—á–µ—Å–∫–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è Telegram\n"
        "‚Ä¢ –†–∞–±–æ—á–∏–µ, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞\n"
        "‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7\n\n"
        "‚è±Ô∏è –°—Ä–æ–∫–∏:\n"
        "‚Ä¢ –î–æ—Å—Ç–∞–≤–∫–∞: 5-15 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã\n"
        f"‚Ä¢ —Ä–µ–≥: –≥–æ–¥ –Ω–∞–∑–∞–¥\n\n"
        "üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:\n"
        "‚Ä¢ –ù–æ–º–µ—Ä–∞ –≤—ã–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ—Ä–æ–º –≤—Ä—É—á–Ω—É—é\n"
        "‚Ä¢ –ü–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã\n"
        "‚Ä¢ –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–∫–∞–º–µ—Ä–æ–≤\n\n"
        "üí≥ –û–ø–ª–∞—Ç–∞:\n"
        f"‚Ä¢ –ü–µ—Ä–µ–≤–æ–¥–æ–º –Ω–∞ –∫–∞—Ä—Ç—É {CARD_NUMBER}\n"
        f"‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–æ–º: {AUTHOR_USERNAME}\n"
        "‚Ä¢ –í—ã–¥–∞—á–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è\n\n"
        "‚≠ê –°–∏—Å—Ç–µ–º–∞ –æ—Ç–∑—ã–≤–æ–≤:\n"
        "‚Ä¢ –û—Å—Ç–∞–≤–ª—è–π—Ç–µ –æ—Ç–∑—ã–≤—ã –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏\n"
        "‚Ä¢ –ü–æ–º–æ–≥–∞–π—Ç–µ –¥—Ä—É–≥–∏–º –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º\n\n"
        "üìä –û—Ç–∑—ã–≤—ã:\n"
        f"‚Ä¢ –¢–ì-–∫–∞–Ω–∞–ª: {CHANNEL_LINK}\n\n"
        "üë®‚Äçüíª –ê–≤—Ç–æ—Ä—ã:\n"
        f"‚Ä¢ {AUTHOR_USERNAME}"
    )
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="üì¢ –ö–∞–Ω–∞–ª —Å –æ—Ç–∑—ã–≤–∞–º–∏", url=CHANNEL_LINK))
    keyboard.add(InlineKeyboardButton(text="‚≠ê –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤", callback_data="leave_review"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        info_text,
        reply_markup=keyboard.as_markup()
    )

# –ê–ª—å—è–Ω—Å
@dp.callback_query(lambda c: c.data == "alliance")
async def show_alliance(callback: types.CallbackQuery):
    alliance_text = (
        "ü§ù –ê–ª—å—è–Ω—Å\n\n"
        "–ë–æ—Ç –±—ã–ª —Å–æ–∑–¥–∞–Ω —Å –ø–æ–º–æ—â—å—é:"
    )
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="@UGLYLELOOSH", url=f"https://t.me/{CREATOR_LINK[1:]}"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        alliance_text,
        reply_markup=keyboard.as_markup()
    )

# ==================== –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ ====================
@dp.callback_query(lambda c: c.data == "admin_panel")
async def admin_panel(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    keyboard = InlineKeyboardBuilder()
    
    keyboard.add(InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä–∞", callback_data="admin_add_numbers"))
    keyboard.add(InlineKeyboardButton(text="üí∞ –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É", callback_data="admin_edit_price_menu"))
    keyboard.add(InlineKeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats"))
    keyboard.add(InlineKeyboardButton(text="üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–∞–Ω—ã", callback_data="admin_show_all"))
    
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        "‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=keyboard.as_markup()
    )

# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–∞–Ω—ã –∞–¥–º–∏–Ω—É
@dp.callback_query(lambda c: c.data == "admin_show_all")
async def admin_show_all(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    data = load_numbers()
    
    if not data:
        await callback.message.answer("üì≠ –ë–∞–∑–∞ –Ω–æ–º–µ—Ä–æ–≤ –ø—É—Å—Ç–∞.")
        return
    
    text = "üìã –í—Å–µ —Å—Ç—Ä–∞–Ω—ã –∏ –Ω–æ–º–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞):\n\n"
    
    for country, info in data.items():
        text += f"üåç {country}\n"
        text += f"   üìû –ö–æ–¥: {info['code']}\n"
        text += f"   üí∞ –¶–µ–Ω–∞: {info['price']}‚ÇΩ\n"
        text += f"   üìä –î–æ—Å—Ç—É–ø–Ω–æ: {info['quantity']} —à—Ç.\n\n"
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_panel"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(text[:4000], reply_markup=keyboard.as_markup())

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
@dp.callback_query(lambda c: c.data == "admin_add_numbers")
async def admin_add_numbers_menu(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    data = load_numbers()
    countries = list(data.keys())
    
    keyboard = InlineKeyboardBuilder()
    
    for country in countries:
        keyboard.add(InlineKeyboardButton(
            text=f"{country} ({data[country]['quantity']} —à—Ç.)",
            callback_data=f"admin_add_qty_{country}"
        ))
    
    keyboard.add(InlineKeyboardButton(text="‚ûï –ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∞", callback_data="admin_new_country"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_panel"))
    
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        "üåç –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–æ–≤:\n\n"
        "üí° –í—ã –±—É–¥–µ—Ç–µ —É–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ö–û–õ–ò–ß–ï–°–¢–í–û –Ω–æ–º–µ—Ä–æ–≤.\n"
        "–†–µ–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä—É –∏ –≤—ã–¥–∞—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é.",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data.startswith("admin_add_qty_"))
async def admin_add_qty_to_country(callback: types.CallbackQuery, state: FSMContext):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    country = callback.data.split("_")[3]
    
    await state.set_state(AdminStates.adding_quantity)
    await state.update_data(country=country)
    
    await callback.message.edit_text(
        f"üìù –í–≤–µ–¥–∏—Ç–µ –ö–û–õ–ò–ß–ï–°–¢–í–û –Ω–æ–º–µ—Ä–æ–≤ –¥–ª—è —Å—Ç—Ä–∞–Ω—ã {country}:\n\n"
        f"üí° –ü—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ. –ù–∞–ø—Ä–∏–º–µ—Ä: 10\n\n"
        f"üìä –¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {load_numbers()[country]['quantity']} —à—Ç."
    )

@dp.message(AdminStates.adding_quantity)
async def process_add_quantity(message: types.Message, state: FSMContext):
    user_data = await state.get_data()
    country = user_data.get('country')
    
    if not country:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞")
        await state.clear()
        return
    
    try:
        quantity = int(message.text.strip())
        
        if quantity <= 0:
            await message.answer("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0")
            return
        
        data = load_numbers()
        
        if country not in data:
            await message.answer("‚ùå –°—Ç—Ä–∞–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        data[country]["quantity"] += quantity
        
        save_numbers(data)
        
        await message.answer(
            f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ {quantity} –Ω–æ–º–µ—Ä–æ–≤ –≤ —Å—Ç—Ä–∞–Ω—É {country}!\n\n"
            f"üìû –ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã: {data[country]['code']}\n"
            f"üí∞ –¶–µ–Ω–∞: {data[country]['price']}‚ÇΩ\n"
            f"üìä –¢–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ: {data[country]['quantity']} —à—Ç.\n\n"
            f"üí° –†–µ–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –±—É–¥—É—Ç –≤—ã–¥–∞–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ—Ä–æ–º –≤—Ä—É—á–Ω—É—é."
        )
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 5)")
        return
    
    await state.clear()

# –ú–µ–Ω—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã
@dp.callback_query(lambda c: c.data == "admin_edit_price_menu")
async def admin_edit_price_menu(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    data = load_numbers()
    countries = list(data.keys())
    
    keyboard = InlineKeyboardBuilder()
    
    for country in countries:
        keyboard.add(InlineKeyboardButton(
            text=f"{country} - {data[country]['price']}‚ÇΩ",
            callback_data=f"admin_edit_price_{country}"
        ))
    
    keyboard.add(InlineKeyboardButton(
        text="‚Ü©Ô∏è –ù–∞–∑–∞–¥",
        callback_data="admin_panel"
    ))
    
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        "üí∞ –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã:",
        reply_markup=keyboard.as_markup()
    )

# –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã
@dp.callback_query(lambda c: c.data.startswith("admin_edit_price_"))
async def admin_edit_price(callback: types.CallbackQuery, state: FSMContext):
    country = callback.data.split("_")[3]
    
    await state.set_state(AdminStates.editing_price)
    await state.update_data(country=country)
    
    current_price = load_numbers()[country]["price"]
    
    await callback.message.edit_text(
        f"üí∞ –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –¥–ª—è {country}: {current_price}‚ÇΩ\n\n"
        f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ):"
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–π —Ü–µ–Ω—ã
@dp.message(AdminStates.editing_price)
async def process_edit_price(message: types.Message, state: FSMContext):
    user_data = await state.get_data()
    country = user_data.get('country')
    
    try:
        new_price = int(message.text.strip())
        
        if new_price <= 0:
            await message.answer("‚ùå –¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0")
            return
        
        data = load_numbers()
        
        if country not in data:
            await message.answer("‚ùå –°—Ç—Ä–∞–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return
        
        data[country]["price"] = new_price
        save_numbers(data)
        
        await message.answer(f"‚úÖ –¶–µ–Ω–∞ –¥–ª—è {country} –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ {new_price}‚ÇΩ")
        
    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ")
        return
    
    await state.clear()

# –ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∞
@dp.callback_query(lambda c: c.data == "admin_new_country")
async def admin_new_country(callback: types.CallbackQuery, state: FSMContext):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    await state.set_state(AdminStates.adding_country)
    
    await callback.message.edit_text(
        "üåç –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω—ã, –∫–æ–¥ –∏ —Ü–µ–Ω—É —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:\n"
        "–ü—Ä–∏–º–µ—Ä: –¢—É—Ä—Ü–∏—è,+90,150\n\n"
        "üí° –§–æ—Ä–º–∞—Ç: –ù–∞–∑–≤–∞–Ω–∏–µ,–ö–æ–¥,–¶–µ–Ω–∞\n"
        "–ü—Ä–∏–º–µ—Ä—ã:\n"
        "‚Ä¢ –ì–µ—Ä–º–∞–Ω–∏—è,+49,180\n"
        "‚Ä¢ –§—Ä–∞–Ω—Ü–∏—è,+33,170\n"
        "‚Ä¢ –°–®–ê,+1,200"
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω—ã
@dp.message(AdminStates.adding_country)
async def process_new_country(message: types.Message, state: FSMContext):
    try:
        parts = [p.strip() for p in message.text.split(',')]
        if len(parts) != 3:
            raise ValueError
        
        country = parts[0]
        code = parts[1]
        price = int(parts[2])
        
        data = load_numbers()
        
        if country in data:
            await message.answer(f"‚ùå –°—Ç—Ä–∞–Ω–∞ {country} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            return
        
        data[country] = {
                        "price": price,
            "quantity": 0,
            "code": code
        }
        
        save_numbers(data)
        
        await message.answer(
            f"‚úÖ –°—Ç—Ä–∞–Ω–∞ {country} —Å–æ–∑–¥–∞–Ω–∞!\n\n"
            f"üìû –ö–æ–¥: {code}\n"
            f"üí∞ –¶–µ–Ω–∞: {price}‚ÇΩ\n"
            f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 0 —à—Ç.\n\n"
            f"üí° –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä–∞ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å.\n"
            f"üì± –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–≤–∏–¥—è—Ç: {country} ({code})"
        )
        await state.clear()
        
    except ValueError:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: –°—Ç—Ä–∞–Ω–∞,–ö–æ–¥,—Ü–µ–Ω–∞\n–ü—Ä–∏–º–µ—Ä: –¢—É—Ä—Ü–∏—è,+90,150")

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
@dp.callback_query(lambda c: c.data == "admin_stats")
async def admin_stats(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    data = load_numbers()
    pending_orders = load_pending_orders()
    reviews_data = load_reviews()
    
    stats_text = "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n\n"
    
    total_available = 0
    total_value = 0
    
    for country, info in data.items():
        available = info["quantity"]
        total_available += available
        
        stats_text += f"üåç {country}:\n"
        stats_text += f"   üìû –ö–æ–¥: {info['code']}\n"
        stats_text += f"   üí∞ –¶–µ–Ω–∞: {info['price']}‚ÇΩ\n"
        stats_text += f"   üìä –î–æ—Å—Ç—É–ø–Ω–æ: {available} —à—Ç.\n"
        stats_text += f"   üíµ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞: {available * info['price']}‚ÇΩ\n\n"
        
        total_value += available * info['price']
    
    stats_text += f"üìà –ò—Ç–æ–≥–æ:\n"
    stats_text += f"   üåç –°—Ç—Ä–∞–Ω: {len(data)}\n"
    stats_text += f"   üì± –í—Å–µ–≥–æ –Ω–æ–º–µ—Ä–æ–≤: {total_available} —à—Ç.\n"
    stats_text += f"   üí∞ –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {total_value}‚ÇΩ\n\n"
    
    stats_text += f"üîÑ –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:\n"
    stats_text += f"   ‚Ä¢ –û–∂–∏–¥–∞—é—Ç –≤—ã–¥–∞—á–∏: {len(pending_orders)} –∑–∞–∫–∞–∑(–æ–≤)\n"
    stats_text += f"   ‚Ä¢ –û—Ç–∑—ã–≤–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ: {len(reviews_data.get('reviews', []))}\n"
    stats_text += f"   ‚Ä¢ üì± –ù–æ–º–µ—Ä–∞ –≤—ã–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ—Ä–æ–º –≤—Ä—É—á–Ω—É—é\n"
    
    reviews = reviews_data.get("reviews", [])
    if reviews:
        avg_rating = sum(r.get("rating", 5) for r in reviews) / len(reviews)
        stats_text += f"   ‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: {avg_rating:.1f}/5 ‚≠ê"
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="admin_stats"))
    keyboard.add(InlineKeyboardButton(text="üìã –û–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã", callback_data="show_pending_orders"))
    keyboard.add(InlineKeyboardButton(text="‚≠ê –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–∑—ã–≤—ã", callback_data="reviews"))
    keyboard.add(InlineKeyboardButton(text="üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å—Ç—Ä–∞–Ω—ã", callback_data="admin_show_all"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_panel"))
    keyboard.adjust(2, 1, 1, 1)
    
    await callback.message.edit_text(
        stats_text,
        reply_markup=keyboard.as_markup()
    )

# –ü–æ–∫–∞–∑–∞—Ç—å –æ–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã
@dp.callback_query(lambda c: c.data == "show_pending_orders")
async def show_pending_orders(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    pending_orders = load_pending_orders()
    
    if not pending_orders:
        await callback.message.answer("‚úÖ –ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤.")
        return
    
    text = "üîÑ –ó–∞–∫–∞–∑—ã, –æ–∂–∏–¥–∞—é—â–∏–µ –≤—ã–¥–∞—á–∏:\n\n"
    
    for order_id, order_info in list(pending_orders.items())[:10]:
        user_info = f"@{order_info['username']}" if order_info['username'] else f"ID: {order_info['user_id']}"
        date = datetime.fromisoformat(order_info['selected_at']).strftime("%H:%M")
        
        text += f"üÜî {order_id[:8]}...\n"
        text += f"üë§ {user_info}\n"
        text += f"üåç {order_info['country']}\n"
        text += f"üìû –ö–æ–¥: {order_info['code']}\n"
        text += f"üí∞ {order_info['price']}‚ÇΩ | üïí {date}\n\n"
        
        keyboard = InlineKeyboardBuilder()
        keyboard.add(InlineKeyboardButton(
            text=f"‚úÖ –í—ã–¥–∞—Ç—å {order_id[:8]}...",
            callback_data=f"confirm_delivery_{order_id}"
        ))
        keyboard.add(InlineKeyboardButton(
            text=f"‚ùå –û—Ç–º–µ–Ω–∏—Ç—å {order_id[:8]}...",
            callback_data=f"cancel_delivery_{order_id}"
        ))
        keyboard.adjust(1)
        
        await callback.message.answer(text, reply_markup=keyboard.as_markup())
        text = ""
    
    keyboard_back = InlineKeyboardBuilder()
    keyboard_back.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É", callback_data="admin_stats"))
    keyboard_back.adjust(1)
    
    if len(pending_orders) > 10:
        await callback.message.answer(
            f"üìã ... –∏ –µ—â–µ {len(pending_orders) - 10} –∑–∞–∫–∞–∑–æ–≤",
            reply_markup=keyboard_back.as_markup()
        )
    else:
        await callback.message.answer(
            "üìã –ö–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞",
            reply_markup=keyboard_back.as_markup()
        )

# –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
@dp.callback_query(lambda c: c.data == "back_to_main")
async def back_to_main(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    await cmd_start(callback.message)

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
@dp.message(Command("reset"))
async def cmd_reset(message: types.Message):
    if message.from_user.id != ADMIN_ID:
        await message.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="‚úÖ –î–∞, —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ", callback_data="confirm_reset"))
    keyboard.add(InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞", callback_data="admin_panel"))
    keyboard.adjust(2)
    
    await message.answer(
        "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n"
        "–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å –í–°–ï –Ω–æ–º–µ—Ä–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.\n"
        "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!\n\n"
        "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data == "confirm_reset")
async def confirm_reset(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    clean_data = {
        "–†–æ—Å—Å–∏—è": {
            "price": 100,
            "quantity": 0,
            "code": "+7"
        },
        "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω": {
            "price": 120,
            "quantity": 0,
            "code": "+7"
        },
        "–£–∫—Ä–∞–∏–Ω–∞": {
            "price": 130,
            "quantity": 0,
            "code": "+380"
        },
        "–ë–µ–ª–∞—Ä—É—Å—å": {
            "price": 140,
            "quantity": 0,
            "code": "+375"
        },
        "–°–®–ê": {
            "price": 200,
            "quantity": 0,
            "code": "+1"
        }
    }
    
    save_numbers(clean_data)
    save_pending_orders({})
    
    await callback.message.edit_text(
        "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–æ—à–µ–Ω–∞!\n"
        "–í—Å–µ –Ω–æ–º–µ—Ä–∞ —É–¥–∞–ª–µ–Ω—ã.\n"
        "–û–∂–∏–¥–∞—é—â–∏–µ –∑–∞–∫–∞–∑—ã –æ—á–∏—â–µ–Ω—ã.\n\n"
        "–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å."
    )

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
async def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    init_data()
    
    print("=" * 60)
    print("ü§ñ –ë–û–¢ –ó–ê–ü–£–©–ï–ù!")
    print("=" * 60)
    print(f"üëë –ê–¥–º–∏–Ω ID: {ADMIN_ID}")
    print(f"üë§ –ê–≤—Ç–æ—Ä ID: {AUTHOR_ID}")
    print(f"üí≥ –ö–∞—Ä—Ç–∞: {CARD_NUMBER[:8]}****")
    print(f"üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞: {SUPPORT_USERNAME}")
    print(f"üë®‚Äçüíª –ê–≤—Ç–æ—Ä: {AUTHOR_USERNAME}")
    print("=" * 60)
    print("‚ú® –û–°–û–ë–ï–ù–ù–û–°–¢–ò –°–ò–°–¢–ï–ú–´:")
    print("1. üì± –ù–æ–º–µ—Ä–∞ –≤—ã–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ—Ä–æ–º –í–†–£–ß–ù–£–Æ")
    print("2. üåç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω—É –∏ –∫–æ–¥")
    print("3. üìä –ê–¥–º–∏–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ö–û–õ–ò–ß–ï–°–¢–í–û –Ω–æ–º–µ—Ä–æ–≤")
    print("4. üí∞ –û–ø–ª–∞—Ç–∞ ‚Üí –ß–µ–∫ –∞–≤—Ç–æ—Ä—É ‚Üí –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞")
    print("5. ‚≠ê –°–∏—Å—Ç–µ–º–∞ –æ—Ç–∑—ã–≤–æ–≤ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º")
    print("=" * 60)
    print("üíµ –û–ø–ª–∞—Ç–∞: –†–£–ë–õ–Ø–ú–ò –ø–æ –∫–∞—Ä—Ç–µ")
    print("üì± –°—Ç–∞—Ç—É—Å: –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    
    try:
        await dp.start_polling(bot)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: {e}")

if __name__ == "__main__":
    asyncio.run(main())

