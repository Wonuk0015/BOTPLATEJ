import asyncio
import logging
import json
import os
import sys
import aiohttp
from datetime import datetime
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.memory import MemoryStorage

# ==================== –ù–ê–°–¢–†–û–ô–ö–ê ====================
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
BOT_TOKEN = os.getenv("BOT_TOKEN")
ADMIN_ID = int(os.getenv("ADMIN_ID", "951154134"))
CRYPTOBOT_TOKEN = os.getenv("CRYPTOBOT_TOKEN")  # –¢–æ–∫–µ–Ω –æ—Ç @CryptoBot

# –ö–æ–Ω—Ç–∞–∫—Ç—ã
SUPPORT_USERNAME = "@svetonaya"
CHANNEL_LINK = "https://t.me/shopsfiznumber"
CREATOR_LINK = "@UGLYLELOOSH"
AUTHOR_USERNAME = "@svetonaya"  # –ê–≤—Ç–æ—Ä –¥–ª—è –≤—ã–¥–∞—á–∏ –Ω–æ–º–µ—Ä–æ–≤

if not BOT_TOKEN:
    logger.error("‚ùå –û–®–ò–ë–ö–ê: BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    sys.exit(1)

if not CRYPTOBOT_TOKEN:
    logger.warning("‚ö†Ô∏è CRYPTOBOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!")

# ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
bot = Bot(token=BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# –§–∞–π–ª—ã –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
DATA_FILE = "numbers.json"

# ==================== –ö–õ–ê–°–° CryptoBot API ====================
class CryptoBot:
    def __init__(self, token: str):
        self.token = token
        self.base_url = "https://pay.crypt.bot/api"
    
    async def create_invoice(self, amount: float, currency: str = "RUB", description: str = ""):
        """–°–æ–∑–¥–∞–µ—Ç —Å—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É"""
        if not self.token:
            return None
            
        url = f"{self.base_url}/createInvoice"
        headers = {
            "Crypto-Pay-API-Token": self.token,
            "Content-Type": "application/json"
        }
        data = {
            "asset": currency,
            "amount": str(amount),
            "description": description,
            "hidden_message": "–û–ø–ª–∞—Ç–∞ –∑–∞ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
            "paid_btn_name": "viewItem",
            "paid_btn_url": "https://t.me/your_bot",
            "allow_comments": True
        }
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(url, json=data, headers=headers) as response:
                    result = await response.json()
                    if result.get("ok"):
                        return result.get("result")
                    else:
                        logger.error(f"–û—à–∏–±–∫–∞ CryptoBot: {result}")
                        return None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞: {e}")
            return None
    
    async def check_invoice(self, invoice_id: str):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å—á–µ—Ç–∞"""
        if not self.token:
            return None
            
        url = f"{self.base_url}/getInvoices?invoice_ids={invoice_id}"
        headers = {"Crypto-Pay-API-Token": self.token}
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(url, headers=headers) as response:
                    result = await response.json()
                    if result.get("ok"):
                        invoices = result.get("result", {}).get("items", [])
                        if invoices:
                            return invoices[0]
                    return None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω–≤–æ–π—Å–∞: {e}")
            return None

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º CryptoBot
cryptobot = CryptoBot(CRYPTOBOT_TOKEN)

# ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –î–ê–ù–ù–´–ú–ò ====================
def load_numbers():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–æ–º–µ—Ä–∞ –∏–∑ —Ñ–∞–π–ª–∞"""
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return {}
    return {}

def save_numbers(data):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–º–µ—Ä–∞ –≤ —Ñ–∞–π–ª"""
    with open(DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

def init_data():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
    data = load_numbers()
    if not data:
        # –ù–∞—á–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã –±–µ–∑ –Ω–æ–º–µ—Ä–æ–≤
        initial_data = {
            "–ë–∞–Ω–≥–ª–∞–¥–µ—à": {
                "price": 120,
                "numbers": []
            },
            "–í—å–µ—Ç–Ω–∞–º": {
                "price": 115,
                "numbers": []
            },
            "–ò–Ω–¥–∏—è": {
                "price": 100,
                "numbers": []
            },
            "–ú—å—è–Ω–º–∞": {
                "price": 130,
                "numbers": []
            }
        }
        save_numbers(initial_data)
        logger.info("‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö")
    return data

# ==================== –ö–û–ú–ê–ù–î–´ –ë–û–¢–ê ====================
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    keyboard = InlineKeyboardBuilder()
    
    keyboard.add(InlineKeyboardButton(text="üì± –ö—É–ø–∏—Ç—å –Ω–æ–º–µ—Ä", callback_data="buy_number"))
    keyboard.add(InlineKeyboardButton(text="‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data="info"))
    keyboard.add(InlineKeyboardButton(text="ü§ù –ê–ª—å—è–Ω—Å", callback_data="alliance"))
    keyboard.add(InlineKeyboardButton(text="üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞", url=f"https://t.me/{SUPPORT_USERNAME[1:]}"))
    
    if message.from_user.id == ADMIN_ID:
        keyboard.add(InlineKeyboardButton(text="‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_panel"))
    
    keyboard.adjust(1)
    
    await message.answer(
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–µ —Ñ–∏–∑ –Ω–æ–º–µ—Ä–æ–≤!\n\n"
        "üõí –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data == "buy_number")
async def buy_number_menu(callback: types.CallbackQuery):
    """–ú–µ–Ω—é –ø–æ–∫—É–ø–∫–∏ –Ω–æ–º–µ—Ä–∞"""
    data = load_numbers()
    
    if not data:
        await callback.message.edit_text("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤.")
        return
    
    keyboard = InlineKeyboardBuilder()
    
    for country, info in data.items():
        available_count = sum(1 for num in info["numbers"] if not num.get("used", False))
        if available_count > 0:
            keyboard.add(InlineKeyboardButton(
                text=f"üìç {country} ({available_count} —à—Ç.) - {info['price']}‚ÇΩ",
                callback_data=f"country_{country}"
            ))
    
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        "üåç –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –Ω–æ–º–µ—Ä–∞:\n"
        "(–≤ —Å–∫–æ–±–∫–∞—Ö —É–∫–∞–∑–∞–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤)",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data.startswith("country_"))
async def show_country_numbers(callback: types.CallbackQuery):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–æ–º–µ—Ä–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã"""
    country = callback.data.split("_")[1]
    data = load_numbers()
    
    if country not in data:
        await callback.answer("‚ùå –°—Ç—Ä–∞–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    country_info = data[country]
    available_numbers = [num for num in country_info["numbers"] if not num.get("used", False)]
    
    if not available_numbers:
        await callback.answer("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤")
        return
    
    keyboard = InlineKeyboardBuilder()
    
    for number in available_numbers:
        keyboard.add(InlineKeyboardButton(
            text=f"üìû {number['number']} - {number['price']}‚ÇΩ",
            callback_data=f"select_{country}_{number['id']}"
        ))
    
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç—Ä–∞–Ω–∞–º", callback_data="buy_number"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        f"üì± –î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ ({country}):\n\n"
        f"üí≥ –¶–µ–Ω–∞: {country_info['price']}‚ÇΩ –∑–∞ –Ω–æ–º–µ—Ä\n"
        f"üìä –î–æ—Å—Ç—É–ø–Ω–æ: {len(available_numbers)} —à—Ç.\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–ª—è –ø–æ–∫—É–ø–∫–∏:",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data.startswith("select_"))
async def select_number(callback: types.CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –Ω–æ–º–µ—Ä–∞"""
    parts = callback.data.split("_")
    country = parts[1]
    number_id = int(parts[2])
    
    data = load_numbers()
    
    # –ù–∞—Ö–æ–¥–∏–º –Ω–æ–º–µ—Ä
    number_info = None
    for num in data[country]["numbers"]:
        if num["id"] == number_id and not num.get("used", False):
            number_info = num
            break
    
    if not number_info:
        await callback.answer("‚ùå –ù–æ–º–µ—Ä —É–∂–µ –ø—Ä–æ–¥–∞–Ω")
        return
    
    price = number_info["price"]
    
    if not CRYPTOBOT_TOKEN:
        # –ï—Å–ª–∏ CryptoBot –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—á–Ω—É—é –æ–ø–ª–∞—Ç—É
        payment_text = (
            f"‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏:\n\n"
            f"üåç –°—Ç—Ä–∞–Ω–∞: {country}\n"
            f"üìû –ù–æ–º–µ—Ä: {number_info['number']}\n"
            f"üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: {price}‚ÇΩ\n\n"
            f"üí≥ –û–ø–ª–∞—Ç–∞ –ø–æ –∫–∞—Ä—Ç–µ:\n\n"
            f"1. –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ {price}‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É\n"
            f"2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞:\n"
            f"   üì® {AUTHOR_USERNAME}\n\n"
            f"3. –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –Ω–æ–º–µ—Ä"
        )
        
        keyboard = InlineKeyboardBuilder()
        keyboard.add(InlineKeyboardButton(
            text="üì® –ù–∞–ø–∏—Å–∞—Ç—å –∞–≤—Ç–æ—Ä—É —Å —á–µ–∫–æ–º", 
            url=f"https://t.me/{AUTHOR_USERNAME[1:]}"
        ))
        keyboard.add(InlineKeyboardButton(
            text="‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –Ω–æ–º–µ—Ä–∞–º", 
            callback_data=f"country_{country}"
        ))
        keyboard.adjust(1)
        
        await callback.message.edit_text(
            payment_text,
            reply_markup=keyboard.as_markup()
        )
        return
    
    # –°–æ–∑–¥–∞–µ–º —Å—á–µ—Ç –≤ CryptoBot
    invoice = await cryptobot.create_invoice(
        amount=price,
        currency="RUB",
        description=f"–ù–æ–º–µ—Ä {country}: {number_info['number']}"
    )
    
    if not invoice or "pay_url" not in invoice:
        await callback.message.edit_text(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—á–µ—Ç –¥–ª—è –æ–ø–ª–∞—Ç—ã.\n"
            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–≤—Ç–æ—Ä–æ–º: {AUTHOR_USERNAME}"
        )
        return
    
    pay_url = invoice["pay_url"]
    invoice_id = invoice["invoice_id"]
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –Ω–æ–º–µ—Ä–µ
    selected_numbers_file = "selected_numbers.json"
    selected_data = {}
    if os.path.exists(selected_numbers_file):
        with open(selected_numbers_file, 'r', encoding='utf-8') as f:
            selected_data = json.load(f)
    
    selected_data[invoice_id] = {
        "user_id": callback.from_user.id,
        "username": callback.from_user.username,
        "country": country,
        "number_id": number_id,
        "number": number_info["number"],
        "price": price,
        "status": "pending",
        "created": datetime.now().isoformat()
    }
    
    with open(selected_numbers_file, 'w', encoding='utf-8') as f:
        json.dump(selected_data, f, ensure_ascii=False, indent=4)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ CryptoBot", url=pay_url))
    keyboard.add(InlineKeyboardButton(text="‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–ª", callback_data=f"check_payment_{invoice_id}"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data=f"country_{country}"))
    
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        f"üí≥ –û–ø–ª–∞—Ç–∞ {price}‚ÇΩ —á–µ—Ä–µ–∑ CryptoBot:\n\n"
        f"1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã\n"
        f"2. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ '‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–ª'\n"
        f"3. –ù–æ–º–µ—Ä –±—É–¥–µ—Ç –≤—ã–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n\n"
        f"üì¶ –ß—Ç–æ –ø–æ–∫—É–ø–∞–µ—Ç–µ:\n"
        f"‚Ä¢ –°—Ç—Ä–∞–Ω–∞: {country}\n"
        f"‚Ä¢ –ù–æ–º–µ—Ä: {number_info['number']}\n"
        f"‚Ä¢ –¶–µ–Ω–∞: {price}‚ÇΩ\n\n"
        f"‚è± –°—á–µ—Ç –¥–µ–π—Å—Ç–≤—É–µ—Ç: 15 –º–∏–Ω—É—Ç",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data.startswith("check_payment_"))
async def check_payment(callback: types.CallbackQuery):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –∏ –≤—ã–¥–∞–µ—Ç –Ω–æ–º–µ—Ä"""
    invoice_id = callback.data.split("_")[2]
    
    await callback.answer("üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–∞—Ç–µ–∂...")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–∞—Ç–µ–∂ –≤ CryptoBot
    invoice = await cryptobot.check_invoice(invoice_id)
    
    if not invoice:
        await callback.message.answer(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç–µ–∂.\n"
            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–≤—Ç–æ—Ä–æ–º: {AUTHOR_USERNAME}"
        )
        return
    
    status = invoice.get("status")
    
    if status == "paid":
        # –ù–∞—Ö–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–º–µ—Ä–µ
        selected_numbers_file = "selected_numbers.json"
        if not os.path.exists(selected_numbers_file):
            await callback.message.answer("‚ùå –û—à–∏–±–∫–∞: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–º–µ—Ä–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return
        
        with open(selected_numbers_file, 'r', encoding='utf-8') as f:
            selected_data = json.load(f)
        
        if invoice_id not in selected_data:
            await callback.message.answer("‚ùå –û—à–∏–±–∫–∞: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–º–µ—Ä–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return
        
        order_info = selected_data[invoice_id]
        country = order_info["country"]
        number_id = order_info["number_id"]
        number = order_info["number"]
        price = order_info["price"]
        
        # –£–¥–∞–ª—è–µ–º –Ω–æ–º–µ—Ä –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        data = load_numbers()
        
        # –ù–∞—Ö–æ–¥–∏–º –∏ —É–¥–∞–ª—è–µ–º –Ω–æ–º–µ—Ä
        for i, num in enumerate(data[country]["numbers"]):
            if num["id"] == number_id and num["number"] == number:
                # –£–î–ê–õ–Ø–ï–ú –Ω–æ–º–µ—Ä –∏–∑ –±–∞–∑—ã
                del data[country]["numbers"][i]
                break
        
        save_numbers(data)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
        order_info["status"] = "completed"
        order_info["completed"] = datetime.now().isoformat()
        selected_data[invoice_id] = order_info
        
        with open(selected_numbers_file, 'w', encoding='utf-8') as f:
            json.dump(selected_data, f, ensure_ascii=False, indent=4)
        
        # –í—ã–¥–∞–µ–º –Ω–æ–º–µ—Ä –ø–æ–∫—É–ø–∞—Ç–µ–ª—é
        await callback.message.edit_text(
            f"‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞!\n\n"
            f"üåç –°—Ç—Ä–∞–Ω–∞: {country}\n"
            f"üìû –ù–æ–º–µ—Ä: <code>{number}</code>\n"
            f"üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: {price}‚ÇΩ\n\n"
            f"üì® –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –Ω–∞–ø–∏—à–∏—Ç–µ –∞–≤—Ç–æ—Ä—É:\n"
            f"{AUTHOR_USERNAME}\n\n"
            f"üìù –°–æ–æ–±—â–∏—Ç–µ –∞–≤—Ç–æ—Ä—É —á—Ç–æ –≤—ã –∫—É–ø–∏–ª–∏ –Ω–æ–º–µ—Ä –∏ –ø–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç —á–µ–∫",
            parse_mode="HTML"
        )
        
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
        try:
            user_info = f"@{callback.from_user.username}" if callback.from_user.username else f"ID: {callback.from_user.id}"
            await bot.send_message(
                ADMIN_ID,
                f"üõí –ù–û–í–ê–Ø –ü–û–ö–£–ü–ö–ê –ß–ï–†–ï–ó CRYPTOBOT!\n\n"
                f"üë§ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å: {user_info}\n"
                f"üåç –°—Ç—Ä–∞–Ω–∞: {country}\n"
                f"üìû –ù–æ–º–µ—Ä: {number}\n"
                f"üí∞ –¶–µ–Ω–∞: {price}‚ÇΩ\n"
                f"üÜî Invoice: {invoice_id}\n"
                f"üïí –í—Ä–µ–º—è: {datetime.now().strftime('%H:%M:%S')}\n\n"
                f"‚ö†Ô∏è –ù–æ–º–µ—Ä —É–¥–∞–ª–µ–Ω –∏–∑ –±–∞–∑—ã. –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä —É {AUTHOR_USERNAME}"
            )
        except:
            pass
        
    elif status == "active":
        await callback.message.answer(
            "‚è≥ –ü–ª–∞—Ç–µ–∂ –µ—â–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω.\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–ª' –ø–æ–∑–∂–µ."
        )
    else:
        await callback.message.answer(
            "‚ùå –ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω.\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Å—á–µ—Ç –¥–ª—è –æ–ø–ª–∞—Ç—ã."
        )

@dp.callback_query(lambda c: c.data == "info")
async def show_info(callback: types.CallbackQuery):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–∏—Å–µ"""
    info_text = (
        "‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–∏—Å–µ:\n\n"
        "üì± –ß—Ç–æ –ø—Ä–æ–¥–∞–µ–º:\n"
        "‚Ä¢ –§–∏–∑–∏—á–µ—Å–∫–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è Telegram\n"
        "‚Ä¢ –†–∞–±–æ—á–∏–µ, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞\n"
        "‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7\n\n"
        "‚è±Ô∏è –°—Ä–æ–∫–∏:\n"
        "‚Ä¢ –î–æ—Å—Ç–∞–≤–∫–∞: –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã\n"
        f"‚Ä¢ —Ä–µ–≥: –≥–æ–¥ –Ω–∞–∑–∞–¥\n\n"
        "üí≥ –û–ø–ª–∞—Ç–∞:\n"
        "‚Ä¢ –ß–µ—Ä–µ–∑ CryptoBot (–∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞)\n"
        "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞\n"
        "‚Ä¢ –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –≤—ã–¥–∞—á–∞\n\n"
        "üì® –í—ã–¥–∞—á–∞ –Ω–æ–º–µ—Ä–æ–≤:\n"
        f"‚Ä¢ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–æ–º–µ—Ä –≤—ã–¥–∞–µ—Ç –∞–≤—Ç–æ—Ä: {AUTHOR_USERNAME}\n\n"
        "üìä –û—Ç–∑—ã–≤—ã:\n"
        f"‚Ä¢ –¢–ì-–∫–∞–Ω–∞–ª: {CHANNEL_LINK}\n\n"
        "üë®‚Äçüíª –ê–≤—Ç–æ—Ä—ã:\n"
        f"‚Ä¢ {AUTHOR_USERNAME}"
    )
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="üì¢ –ö–∞–Ω–∞–ª —Å –æ—Ç–∑—ã–≤–∞–º–∏", url=CHANNEL_LINK))
    keyboard.add(InlineKeyboardButton(text="ü§ù –ê–ª—å—è–Ω—Å", callback_data="alliance"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        info_text,
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data == "alliance")
async def show_alliance(callback: types.CallbackQuery):
    """–ê–ª—å—è–Ω—Å"""
    alliance_text = (
        "ü§ù –ê–ª—å—è–Ω—Å\n\n"
        "–ë–æ—Ç –±—ã–ª —Å–æ–∑–¥–∞–Ω —Å –ø–æ–º–æ—â—å—é:"
    )
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="@UGLYLELOOSH", url=f"https://t.me/{CREATOR_LINK[1:]}"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        alliance_text,
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data == "back_to_main")
async def back_to_main(callback: types.CallbackQuery):
    """–ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    await cmd_start(callback.message)

# ==================== –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è) ====================
class AdminStates(StatesGroup):
    adding_number = State()
    adding_country = State()
    editing_price = State()

@dp.callback_query(lambda c: c.data == "admin_panel")
async def admin_panel(callback: types.CallbackQuery):
    """–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"""
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    keyboard = InlineKeyboardBuilder()
    
    keyboard.add(InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä", callback_data="admin_add_number_menu"))
    keyboard.add(InlineKeyboardButton(text="üí∞ –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É", callback_data="admin_edit_price_menu"))
    keyboard.add(InlineKeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
    
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        "‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data == "admin_add_number_menu")
async def admin_add_number_menu(callback: types.CallbackQuery):
    """–ú–µ–Ω—é –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞"""
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    data = load_numbers()
    countries = list(data.keys())
    
    keyboard = InlineKeyboardBuilder()
    
    for country in countries:
        keyboard.add(InlineKeyboardButton(
            text=country,
            callback_data=f"admin_add_to_{country}"
        ))
    
    keyboard.add(InlineKeyboardButton(text="‚ûï –ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∞", callback_data="admin_new_country"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_panel"))
    
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        "üåç –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞:",
        reply_markup=keyboard.as_markup()
    )

@dp.callback_query(lambda c: c.data.startswith("admin_add_to_"))
async def admin_add_to_country(callback: types.CallbackQuery, state: FSMContext):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –≤ —Å—Ç—Ä–∞–Ω—É"""
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    country = callback.data.split("_")[3]
    
    await state.set_state(AdminStates.adding_number)
    await state.update_data(country=country)
    
    await callback.message.edit_text(
        f"üìù –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–ª—è —Å—Ç—Ä–∞–Ω—ã {country} –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        f"+1234567890\n\n"
        f"–¶–µ–Ω–∞ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ({load_numbers()[country]['price']}‚ÇΩ)"
    )

@dp.message(AdminStates.adding_number)
async def process_add_number(message: types.Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞"""
    user_data = await state.get_data()
    country = user_data.get('country')
    
    if not country:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞")
        await state.clear()
        return
    
    phone_number = message.text.strip()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
    if not (phone_number.startswith('+') and phone_number[1:].replace(' ', '').isdigit() and len(phone_number) > 5):
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ +1234567890")
        return
    
    data = load_numbers()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    for num in data[country]["numbers"]:
        if num["number"] == phone_number:
            await message.answer(f"‚ùå –ù–æ–º–µ—Ä {phone_number} —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ")
            return
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID
    if data[country]["numbers"]:
        new_id = max(num['id'] for num in data[country]["numbers"]) + 1
    else:
        new_id = 1
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä
    data[country]["numbers"].append({
        "id": new_id,
        "number": phone_number,
        "price": data[country]["price"],
        "used": False
    })
    
    save_numbers(data)
    
    await message.answer(
        f"‚úÖ –ù–æ–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω!\n"
        f"üåç –°—Ç—Ä–∞–Ω–∞: {country}\n"
        f"üìû –ù–æ–º–µ—Ä: {phone_number}\n"
        f"üí∞ –¶–µ–Ω–∞: {data[country]['price']}‚ÇΩ\n"
        f"üÜî ID: {new_id}"
    )
    
    await state.clear()

@dp.callback_query(lambda c: c.data == "admin_stats")
async def admin_stats(callback: types.CallbackQuery):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞"""
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    data = load_numbers()
    
    stats_text = "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n\n"
    
    total_numbers = 0
    total_available = 0
    
    for country, info in data.items():
        numbers = info["numbers"]
        available = sum(1 for num in numbers if not num.get("used", False))
        total_numbers += len(numbers)
        total_available += available
        
        stats_text += f"üåç {country}:\n"
        stats_text += f"   ‚Ä¢ –¶–µ–Ω–∞: {info['price']}‚ÇΩ\n"
        stats_text += f"   ‚Ä¢ –í—Å–µ–≥–æ: {len(numbers)} —à—Ç.\n"
        stats_text += f"   ‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ: {available} —à—Ç.\n\n"
    
    stats_text += f"üìà –ò—Ç–æ–≥–æ:\n"
    stats_text += f"   ‚Ä¢ –í—Å–µ–≥–æ –Ω–æ–º–µ—Ä–æ–≤: {total_numbers} —à—Ç.\n"
    stats_text += f"   ‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ: {total_available} —à—Ç.\n"
    stats_text += f"   ‚Ä¢ –ü—Ä–æ–¥–∞–Ω–æ: {total_numbers - total_available} —à—Ç."
    
    keyboard = InlineKeyboardBuilder()
    keyboard.add(InlineKeyboardButton(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="admin_stats"))
    keyboard.add(InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="admin_panel"))
    keyboard.adjust(2)
    
    await callback.message.edit_text(
        stats_text,
        reply_markup=keyboard.as_markup()
    )

# ==================== –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ====================
async def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
    init_data()
    
    logger.info("=" * 50)
    logger.info("ü§ñ –ë–û–¢ –ó–ê–ü–£–©–ï–ù!")
    logger.info("=" * 50)
    logger.info(f"üëë –ê–¥–º–∏–Ω ID: {ADMIN_ID}")
    logger.info(f"üí≥ CryptoBot: {'‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω' if CRYPTOBOT_TOKEN else '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}")
    logger.info(f"üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞: {SUPPORT_USERNAME}")
    logger.info(f"üë§ –ê–≤—Ç–æ—Ä –¥–ª—è –≤—ã–¥–∞—á–∏: {AUTHOR_USERNAME}")
    logger.info("=" * 50)
    
    try:
        await dp.start_polling(bot)
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: {e}")

if __name__ == "__main__":
    asyncio.run(main())


